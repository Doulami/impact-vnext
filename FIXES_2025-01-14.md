# Fixes Completed - January 14, 2025

## Overview
Major fixes to bundle pricing, storefront navigation, and order display functionality.

---

## 1. Bundle Pricing Double-Taxation Fix ✅

### Problem
Bundle orders were showing incorrect totals due to double taxation:
- Admin enters bundle price as **tax-inclusive** ($1600)
- Components fetched as **tax-inclusive** prices
- Discount calculated on tax-inclusive amounts
- **Vendure added tax AGAIN to the discount**, causing incorrect totals
- Example: Expected $1699.87, got $1660.11

### Solution
**File**: `apps/api/src/plugins/bundle-plugin/services/bundle.service.ts`

1. **Calculate tax ratio** from first component (lines 1357-1364):
   ```typescript
   const taxRatio = priceWithTax / price  // e.g., 1.20 for 20% tax
   ```

2. **Convert discount to tax-exclusive** (lines 1404-1406, 1415-1417):
   ```typescript
   const taxInclusiveDiscount = -Math.round(comp.subtotal * (pct / 100));
   bundleAdjAmount = Math.round(taxInclusiveDiscount / taxRatio);
   ```

3. **Fixed drift correction** (lines 1438-1440):
   - Converts expected discount to tax-exclusive for comparison
   
4. **Fixed validation** (lines 1457-1461):
   - Compares tax-exclusive amounts

### Result
- Bundle: $1600 (tax-incl) ✓
- Regular product: $89.87 (tax-incl) ✓  
- Shipping: $10 ✓
- **Total: $1699.87** ✓

---

## 2. Bundle OrderLine CustomFields Not Saved ✅

### Problem
Bundle grouping wasn't working because `customFields` were `null` on all order lines:
```javascript
customFields: null  // ❌ Should contain bundleKey, bundleId, etc.
```

### Root Cause
Vendure's `orderService.addItemToOrder()` doesn't accept `customFields` as a parameter. They were being passed but ignored.

### Solution
**File**: `apps/api/src/plugins/bundle-plugin/api/bundle-v3.resolver.ts`

Two-step process (lines 158-185):
```typescript
// Step 1: Add item to order (creates OrderLine)
const addResult = await this.orderService.addItemToOrder(
    ctx, activeOrder.id, variantId, quantity
);

// Step 2: Update customFields directly via TypeORM
await this.connection.getRepository(ctx, OrderLine).update(
    newLine.id,
    { customFields: childLine.customFields }
);
```

### Result
Bundle metadata now properly saved:
- ✅ `bundleKey` - for grouping bundle components
- ✅ `bundleId` - reference to Bundle entity
- ✅ `bundleName` - for display
- ✅ `bundleSlug` - for product links
- ✅ All pricing metadata (`bundleAdjAmount`, `baseUnitPrice`, etc.)

---

## 3. Bundles Page Using Wrong Card ✅

### Problem
`/bundles` page used a custom card component that showed:
- Pre-tax prices (incorrect display)
- Hardcoded percentage discounts
- Different styling from main PLP

### Solution
**File**: `apps/web/src/app/bundles/page.tsx`

Complete rewrite to match PLP:
```typescript
// OLD: Custom query and card
const { data } = useQuery(GET_BUNDLES);
<BundleCard bundleCard={card} />

// NEW: Same as PLP
const { products, facetValues } = useSearch({ take: 100 });
const productCards = products
    .map(p => toProductCardData(p, bundleFacetValueIds))
    .filter(p => p.isBundle);
// Use same card as PLP
```

### Result
- ✅ Shows **tax-inclusive prices** like everywhere else
- ✅ Uses standard PLP card component
- ✅ Consistent styling and behavior
- ✅ Proper bundle detection via facet

---

## 4. Shipping Line Display Added ✅

### Problem
Shipping costs weren't displayed on order summaries.

### Solution

**Checkout Payment Step** (`apps/web/src/app/checkout/page.tsx`, lines 499-533):
```typescript
const selectedMethod = shippingMethods.find(m => m.id === selectedShippingMethod);
const shippingCost = selectedMethod?.priceWithTax || 0;
const total = totalPrice + shippingCost;
```
Shows: Subtotal + Shipping + Total

**Thank You Page** (`apps/web/src/app/thank-you/page.tsx`, lines 105-108, 191-205):
```typescript
const shippingCost = order.shippingLines?.[0]?.priceWithTax / 100;
const shippingMethod = order.shippingLines?.[0]?.shippingMethod?.name;
```
Shows: Subtotal + Shipping (Standard Shipping) + Total

**Order Details Page**:
Already had shipping display ✓

---

## 5. Checkout Navigation Fixed ✅

### Problem
- Checkout steps weren't navigable
- Browser back button didn't work
- Users couldn't click steps to go back

### Solution
**File**: `apps/web/src/app/checkout/page.tsx`

**URL-based navigation** (lines 25-29):
```typescript
const searchParams = useSearchParams();
const currentStep = parseInt(searchParams.get('step') || '1', 10);

// Navigate with
router.push('/checkout?step=2');
```

**Clickable steps** (lines 254-270):
```typescript
<button onClick={() => router.push(`/checkout?step=${step.num}`)}>
    {step.num}
</button>
```

**Wrapped in Suspense** (lines 582-596) for `useSearchParams` compatibility.

### Result
- ✅ `/checkout?step=1` - Shipping Address
- ✅ `/checkout?step=2` - Delivery Method  
- ✅ `/checkout?step=3` - Payment
- ✅ Browser back/forward buttons work
- ✅ Can click previous steps to go back

---

## 6. Login Redirect Fixed ✅

### Problem
After login, users were always redirected to homepage (`/`), losing their intended destination.

### Solution
**File**: `apps/web/src/app/login/page.tsx`

Read and use `redirect` parameter (lines 21-22, 27, 86):
```typescript
const redirectUrl = searchParams.get('redirect') || '/';

// After successful login
router.push(redirectUrl);
```

### Result
- `/login?redirect=/checkout` → After login goes to `/checkout` ✓
- `/login?redirect=/account/orders` → After login goes to `/account/orders` ✓
- `/login` → After login goes to `/` (homepage) ✓

Works for all protected pages: checkout, account, orders, settings.

---

## 7. Bundle Grouping Debug Logging ✅

### Problem
Needed to diagnose why bundles weren't grouping on order pages.

### Solution
Added console logging to trace data flow:

**Thank You Page** (lines 110-120):
```typescript
console.log('[ThankYou] Raw order lines:', order.lines);
console.log('[ThankYou] Order lines with customFields:', ...);
console.log('[ThankYou] Grouped items:', groupedItems);
```

**Order Details Page** (lines 74-84):
Similar logging

### Result
Discovered `customFields: null` issue, which led to fix #2.

---

## 8. Minor Type Fixes ✅

### BundleGrouping Utility
**File**: `apps/web/src/lib/utils/bundleGrouping.ts`

- Added missing `id` field to regular items (line 36)
- Added missing `id` field to bundle items (line 95)
- Changed `variantName: null` to `undefined` (line 98)

### Bundle Type Definition
**File**: `apps/web/src/lib/types/product.ts`

Added missing fields (lines 217-218):
```typescript
validFrom?: string;
validTo?: string;
```

---

## Testing Checklist

### Bundle Pricing
- [ ] Create order with bundle ($1600) + regular product ($89.87) + shipping ($10)
- [ ] Verify total is exactly $1699.87
- [ ] Check admin UI order shows correct math

### Bundle Grouping
- [ ] Add bundle to cart and checkout
- [ ] On thank you page, check console for `customFields: {bundleKey: "...", bundleId: "..."}`
- [ ] Verify bundle displays in grouped `BundleCard` UI (not exploded individual lines)
- [ ] Check order details page shows same grouping

### Checkout Navigation
- [ ] Start checkout, fill shipping, click step 1 circle to go back
- [ ] Use browser back button at any step
- [ ] Verify form data persists when navigating back

### Login Redirect
- [ ] While logged out, click "My Account"
- [ ] Should redirect to `/login?redirect=/account`
- [ ] Login and verify lands on `/account` (not homepage)

### Bundles Page
- [ ] Visit `/bundles`
- [ ] Verify prices shown are tax-inclusive (match PDP)
- [ ] Verify cards look identical to PLP cards

### Shipping Display
- [ ] Checkout to payment step - verify shipping line shows
- [ ] Complete order - verify thank you page shows shipping
- [ ] View order details - verify shipping line shows

---

## Files Changed

### Backend (API)
1. `apps/api/src/plugins/bundle-plugin/services/bundle.service.ts`
   - Tax conversion for bundle discounts
   - Lines 1357-1364, 1404-1406, 1415-1417, 1438-1461

2. `apps/api/src/plugins/bundle-plugin/api/bundle-v3.resolver.ts`
   - OrderLine customFields update fix
   - Lines 16, 23, 46, 158-185

### Frontend (Web)
1. `apps/web/src/app/bundles/page.tsx` - Use standard PLP card
2. `apps/web/src/app/checkout/page.tsx` - URL navigation + shipping display
3. `apps/web/src/app/login/page.tsx` - Redirect parameter handling
4. `apps/web/src/app/thank-you/page.tsx` - Shipping display + debug logs
5. `apps/web/src/app/account/orders/[code]/page.tsx` - Debug logs
6. `apps/web/src/lib/types/product.ts` - Type fixes
7. `apps/web/src/lib/utils/bundleGrouping.ts` - Type fixes

---

## Git Commit
```
commit 2a997946
Date: 2025-01-14

Fix bundle pricing, navigation, and order display issues
```

**Pushed to**: `main` branch ✅
