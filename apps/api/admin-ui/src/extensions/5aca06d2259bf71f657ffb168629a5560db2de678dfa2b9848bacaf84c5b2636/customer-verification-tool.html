<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Verification Tool - Impact Nutrition Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .btn-small {
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 5px;
        }
        .logo {
            color: #333;
            margin-bottom: 10px;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">üèãÔ∏è Impact Nutrition - Customer Verification Tool</h1>
            <p>Admin tool for managing customer email verification status</p>
        </div>

        <!-- Auth Section -->
        <div class="section">
            <h2>Authentication</h2>
            <div class="info-box">
                <strong>API Endpoint:</strong> <span id="api-url">http://localhost:3000/admin-api</span><br>
                <strong>Status:</strong> <span id="auth-status">Not authenticated</span>
            </div>
            <div class="form-group">
                <label>Admin Username:</label>
                <input type="text" id="username" placeholder="Enter admin username">
            </div>
            <div class="form-group">
                <label>Admin Password:</label>
                <input type="password" id="password" placeholder="Enter admin password">
            </div>
            <button onclick="authenticate()">Login to Admin API</button>
            <div id="auth-result"></div>
        </div>

        <!-- Unverified Customers Section -->
        <div class="section">
            <h2>Unverified Customers</h2>
            <button onclick="loadUnverifiedCustomers()">Load Unverified Customers</button>
            <div id="unverified-customers"></div>
        </div>

        <!-- Manual Verification Section -->
        <div class="section">
            <h2>Manual Verification</h2>
            <div class="form-group">
                <label>Customer ID:</label>
                <input type="text" id="customer-id" placeholder="Enter Customer ID (e.g., 1, 2, 3...)">
            </div>
            <button onclick="verifyCustomerById()">Verify Customer</button>
            <div id="manual-verify-result"></div>
        </div>

        <!-- Bulk Verification Section -->
        <div class="section">
            <h2>Bulk Email Verification</h2>
            <div class="form-group">
                <label>Email Addresses (one per line):</label>
                <textarea id="bulk-emails" rows="5" placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"></textarea>
            </div>
            <button onclick="bulkVerifyCustomers()">Bulk Verify Customers</button>
            <div id="bulk-verify-result"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        const API_URL = 'http://localhost:3000/admin-api';

        async function authenticate() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showResult('auth-result', 'Please enter username and password', 'error');
                return;
            }

            const mutation = `
                mutation Authenticate($username: String!, $password: String!) {
                    authenticate(input: { native: { username: $username, password: $password } }) {
                        ... on CurrentUser {
                            id
                            identifier
                        }
                        ... on ErrorResult {
                            message
                        }
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: mutation,
                        variables: { username, password }
                    })
                });

                const data = await response.json();
                
                if (data.errors) {
                    showResult('auth-result', 'Authentication failed: ' + data.errors[0].message, 'error');
                    return;
                }

                const result = data.data.authenticate;
                if (result.id) {
                    authToken = response.headers.get('vendure-auth-token') || 'authenticated';
                    document.getElementById('auth-status').textContent = 'Authenticated as ' + result.identifier;
                    showResult('auth-result', 'Successfully authenticated!', 'success');
                    
                    // Auto-load unverified customers
                    setTimeout(loadUnverifiedCustomers, 500);
                } else {
                    showResult('auth-result', 'Authentication failed: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('auth-result', 'Network error: ' + error.message, 'error');
            }
        }

        async function loadUnverifiedCustomers() {
            if (!authToken) {
                showResult('unverified-customers', 'Please authenticate first', 'error');
                return;
            }

            const query = `
                query UnverifiedCustomers {
                    unverifiedCustomers(options: { take: 50 }) {
                        items {
                            id
                            emailAddress
                            firstName
                            lastName
                            createdAt
                        }
                        totalItems
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                
                if (data.errors) {
                    showResult('unverified-customers', 'Error: ' + data.errors[0].message, 'error');
                    return;
                }

                const customers = data.data.unverifiedCustomers.items;
                const total = data.data.unverifiedCustomers.totalItems;

                let html = `<div class="results">`;
                if (customers.length === 0) {
                    html += `<p class="success">üéâ All customers are verified! (Total: ${total})</p>`;
                } else {
                    html += `<p><strong>${customers.length} unverified customers found (of ${total} total)</strong></p>`;
                    html += `<table><tr><th>ID</th><th>Email</th><th>Name</th><th>Actions</th></tr>`;
                    customers.forEach(customer => {
                        html += `
                            <tr>
                                <td>${customer.id}</td>
                                <td>${customer.emailAddress}</td>
                                <td>${customer.firstName} ${customer.lastName}</td>
                                <td>
                                    <button class="btn-small" onclick="verifyCustomerById('${customer.id}')">
                                        Verify
                                    </button>
                                </td>
                            </tr>`;
                    });
                    html += `</table>`;
                }
                html += `</div>`;

                document.getElementById('unverified-customers').innerHTML = html;
            } catch (error) {
                showResult('unverified-customers', 'Network error: ' + error.message, 'error');
            }
        }

        async function verifyCustomerById(customerId) {
            if (!customerId) {
                customerId = document.getElementById('customer-id').value;
            }
            
            if (!customerId) {
                showResult('manual-verify-result', 'Please enter a Customer ID', 'error');
                return;
            }

            if (!authToken) {
                showResult('manual-verify-result', 'Please authenticate first', 'error');
                return;
            }

            const mutation = `
                mutation ManuallyVerifyCustomer($customerId: ID!) {
                    manuallyVerifyCustomer(customerId: $customerId) {
                        ... on ManualVerifyCustomerSuccess {
                            success
                            message
                            customer {
                                emailAddress
                            }
                        }
                        ... on ManualVerifyCustomerError {
                            errorCode
                            message
                        }
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: mutation,
                        variables: { customerId }
                    })
                });

                const data = await response.json();
                
                if (data.errors) {
                    showResult('manual-verify-result', 'Error: ' + data.errors[0].message, 'error');
                    return;
                }

                const result = data.data.manuallyVerifyCustomer;
                if (result.success) {
                    showResult('manual-verify-result', 
                        `‚úÖ Customer verified successfully!\\nüìß Email: ${result.customer.emailAddress}`, 
                        'success');
                    // Refresh unverified customers list
                    setTimeout(loadUnverifiedCustomers, 1000);
                } else {
                    showResult('manual-verify-result', 
                        `‚ùå Verification failed: ${result.message}`, 
                        'error');
                }
            } catch (error) {
                showResult('manual-verify-result', 'Network error: ' + error.message, 'error');
            }
        }

        async function bulkVerifyCustomers() {
            const emailsText = document.getElementById('bulk-emails').value;
            if (!emailsText.trim()) {
                showResult('bulk-verify-result', 'Please enter email addresses', 'error');
                return;
            }

            if (!authToken) {
                showResult('bulk-verify-result', 'Please authenticate first', 'error');
                return;
            }

            const emailAddresses = emailsText.split('\\n')
                .map(email => email.trim())
                .filter(email => email);

            const mutation = `
                mutation BulkVerifyCustomers($emailAddresses: [String!]!) {
                    bulkVerifyCustomers(emailAddresses: $emailAddresses) {
                        totalProcessed
                        successCount
                        errorCount
                        message
                        errors
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: mutation,
                        variables: { emailAddresses }
                    })
                });

                const data = await response.json();
                
                if (data.errors) {
                    showResult('bulk-verify-result', 'Error: ' + data.errors[0].message, 'error');
                    return;
                }

                const result = data.data.bulkVerifyCustomers;
                let message = `üìä Bulk Verification Complete:\\n`;
                message += `‚úÖ Processed: ${result.totalProcessed}\\n`;
                message += `‚úÖ Successful: ${result.successCount}\\n`;
                message += `‚ùå Errors: ${result.errorCount}\\n`;
                
                if (result.errors && result.errors.length > 0) {
                    message += `\\nüîç Error Details:\\n${result.errors.slice(0, 5).join('\\n')}`;
                    if (result.errors.length > 5) {
                        message += `\\n... and ${result.errors.length - 5} more errors`;
                    }
                }

                const type = result.errorCount === 0 ? 'success' : 'error';
                showResult('bulk-verify-result', message, type);
                
                // Clear form and refresh list
                document.getElementById('bulk-emails').value = '';
                setTimeout(loadUnverifiedCustomers, 1000);
                
            } catch (error) {
                showResult('bulk-verify-result', 'Network error: ' + error.message, 'error');
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message.replace(/\\n/g, '<br>')}</div>`;
        }
    </script>
</body>
</html>