<vdr-action-bar>
    <vdr-ab-left>
        <vdr-language-selector
            [disabled]="isLoading$ | async"
            [availableLanguageCodes]="availableLanguages$ | async"
            [currentLanguageCode]="contentLanguage$ | async"
            (languageCodeChange)="setLanguage($event)"
        ></vdr-language-selector>
    </vdr-ab-left>
    
    <vdr-ab-right>
        <vdr-action-bar-items locationId="bundle-list"></vdr-action-bar-items>
        <button
            class="btn btn-primary"
            [disabled]="isLoading$ | async"
            (click)="onCreateBundle()"
        >
            <clr-icon shape="plus"></clr-icon>
            Create Bundle
        </button>
    </vdr-ab-right>
</vdr-action-bar>

<!-- Global Bundle Promotion Settings -->
<vdr-card class="mb-4">
    <div class="clr-row">
        <div class="clr-col-12">
            <h3 class="mb-3">Global Promotion Policy</h3>
            <p class="text-muted small mb-3">
                Control how external promotions and coupon codes interact with bundles site-wide.
            </p>
        </div>
    </div>
    
    <div class="clr-row">
        <div class="clr-col-md-6">
            <vdr-form-field 
                label="Site-wide Promotion Policy" 
                for="siteWidePromosAffectBundles"
                tooltip="Default behavior for external promotions on bundles">
                <select 
                    clrSelect
                    id="siteWidePromosAffectBundles"
                    [(ngModel)]="globalPolicy"
                    (change)="onGlobalPolicyChange()"
                >
                    <option value="Exclude">Exclude (Safe - Prevents double-discounting)</option>
                    <option value="Allow">Allow (Risky - May cause double-discounting)</option>
                </select>
                <div class="help-text mt-2">
                    <p *ngIf="globalPolicy === 'Exclude'" class="text-success mb-0">
                        <clr-icon shape="shield-check"></clr-icon>
                        <strong>Recommended:</strong> External promotions will NOT apply to bundles by default.
                    </p>
                    <p *ngIf="globalPolicy === 'Allow'" class="text-warning mb-0">
                        <clr-icon shape="exclamation-triangle"></clr-icon>
                        <strong>Warning:</strong> May cause double-discounting. Use per-bundle controls to prevent issues.
                    </p>
                </div>
            </vdr-form-field>
        </div>
        
        <div class="clr-col-md-6">
            <vdr-form-field 
                label="Maximum Discount Cap" 
                for="maxCumulativeDiscount"
                tooltip="Maximum combined discount percentage allowed (bundle + external promos)">
                <div class="input-group">
                    <input 
                        type="number" 
                        id="maxCumulativeDiscount"
                        [(ngModel)]="maxDiscountPercent"
                        (change)="onMaxDiscountChange()"
                        min="0"
                        max="100"
                        step="5"
                    />
                    <span class="input-group-text">%</span>
                </div>
                <div class="help-text mt-2">
                    <p class="text-muted small mb-0">
                        Current: <strong>{{maxDiscountPercent}}%</strong> maximum combined discount
                    </p>
                </div>
            </vdr-form-field>
        </div>
    </div>
    
    <div class="clr-row mt-3" *ngIf="configDirty">
        <div class="clr-col-12">
            <div class="alert alert-warning">
                <clr-icon shape="info-circle"></clr-icon>
                <strong>Note:</strong> These settings require server restart to take effect. Changes are saved to configuration file.
            </div>
        </div>
    </div>
</vdr-card>

<vdr-data-table-2
    id="bundle-list"
    [items]="items$ | async"
    [itemsPerPage]="itemsPerPage$ | async"
    [totalItems]="totalItems$ | async"
    [currentPage]="currentPage$ | async"
    [filters]="filters"
    [sorts]="sorts"
    [loading]="isLoading$ | async"
    (pageChange)="setPageNumber($event)"
    (itemsPerPageChange)="setItemsPerPage($event)"
    (filterChange)="setFilterTerm($event)"
    (sortChange)="setSortBy($event.sort, $event.direction)"
>
    <vdr-bulk-action-menu
        locationId="bundle-list-bulk"
        [hostComponent]="this"
        [selectionManager]="selectionManager"
    >
        <button
            type="button"
            class="btn btn-outline"
            [disabled]="selection.isEmpty()"
            (click)="onBulkPublish()"
        >
            <clr-icon shape="play"></clr-icon>
            Publish Selected
        </button>
        <button
            type="button"
            class="btn btn-outline"
            [disabled]="selection.isEmpty()"
            (click)="onBulkArchive()"
        >
            <clr-icon shape="archive"></clr-icon>
            Archive Selected
        </button>
    </vdr-bulk-action-menu>

    <vdr-dt2-search
        [searchTermControl]="searchTermControl"
        searchTermPlaceholder="Search bundles..."
    ></vdr-dt2-search>

    <!-- Bundle Status Column -->
    <vdr-dt2-column 
        id="status" 
        heading="Status"
        hiddenByDefault="false"
    >
        <ng-template let-bundle="item">
            <vdr-chip
                [colorType]="getStatusColor(bundle.status)"
                [icon]="getStatusIcon(bundle.status)"
            >
                {{ bundle.status }}
            </vdr-chip>
            <span *ngIf="bundle.status === 'BROKEN' && bundle.brokenReason" 
                  class="text-muted small d-block">
                {{ bundle.brokenReason }}
            </span>
            <span *ngIf="!bundle.isAvailable && bundle.validTo && bundle.status !== 'EXPIRED'" 
                  class="text-warning small d-block">
                âš  Expired: {{ bundle.validTo | date:'short' }}
            </span>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Name Column -->
    <vdr-dt2-column 
        id="name" 
        heading="Name"
        hiddenByDefault="false"
        [optional]="false"
    >
        <ng-template let-bundle="item">
            <a class="button-ghost" [routerLink]="['./', bundle.id]">
                <span class="bundle-name">{{ bundle.shellProduct?.name || 'Bundle #' + bundle.id }}</span>
            </a>
            <div class="bundle-meta">
                <span *ngIf="bundle.category" class="category-badge">{{ bundle.category }}</span>
                <span *ngIf="bundle.shellProduct?.slug" class="text-muted small">{{ bundle.shellProduct.slug }}</span>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Type Column -->
    <vdr-dt2-column 
        id="discountType" 
        heading="Type"
        hiddenByDefault="false"
    >
        <ng-template let-bundle="item">
            <div class="discount-type">
                <span class="discount-label">{{ bundle.discountType === 'fixed' ? 'Fixed Price' : 'Percentage Off' }}</span>
                <div class="discount-value">
                    <span *ngIf="bundle.discountType === 'fixed'">
                        {{ bundle.fixedPrice | localeCurrency }}
                    </span>
                    <span *ngIf="bundle.discountType === 'percent'">
                        {{ bundle.percentOff }}% off
                    </span>
                </div>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Components Column -->
    <vdr-dt2-column 
        id="components" 
        heading="Components"
        hiddenByDefault="false"
    >
        <ng-template let-bundle="item">
            <div class="components-info">
                <span class="component-count">{{ bundle.items?.length || 0 }} items</span>
                <div class="component-total">
                    Price: {{ bundle.effectivePrice | localeCurrency }}
                </div>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Savings Column -->
    <vdr-dt2-column 
        id="savings" 
        heading="Savings"
        hiddenByDefault="true"
    >
        <ng-template let-bundle="item">
            <div class="savings-info">
                <span class="savings-amount">{{ bundle.totalSavings | localeCurrency }}</span>
                <div class="savings-percent text-muted small" *ngIf="bundle.totalSavings && bundle.effectivePrice">
                    {{ ((bundle.totalSavings / (bundle.effectivePrice + bundle.totalSavings)) * 100) | number:'1.1-1' }}%
                </div>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Health Column -->
    <vdr-dt2-column 
        id="health" 
        heading="Health"
        hiddenByDefault="true"
    >
        <ng-template let-bundle="item">
            <div class="bundle-health">
                <clr-icon 
                    *ngIf="bundle.isAvailable" 
                    shape="check-circle" 
                    class="text-success"
                    title="Bundle is available"
                ></clr-icon>
                <clr-icon 
                    *ngIf="!bundle.isAvailable" 
                    shape="exclamation-triangle" 
                    class="text-warning"
                    title="Bundle has availability issues"
                ></clr-icon>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Version Column -->
    <vdr-dt2-column 
        id="version" 
        heading="Version"
        hiddenByDefault="true"
    >
        <ng-template let-bundle="item">
            <span class="version-badge">v{{ bundle.version }}</span>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Updated Column -->
    <vdr-dt2-column 
        id="updatedAt" 
        heading="Updated"
        hiddenByDefault="false"
    >
        <ng-template let-bundle="item">
            <vdr-datetime [datetime]="bundle.updatedAt"></vdr-datetime>
            <div *ngIf="bundle.lastRecomputedAt" class="text-muted small">
                Recomputed: <vdr-datetime [datetime]="bundle.lastRecomputedAt"></vdr-datetime>
            </div>
        </ng-template>
    </vdr-dt2-column>

    <!-- Bundle Actions Column -->
    <vdr-dt2-column 
        id="actions" 
        heading=""
        hiddenByDefault="false"
    >
        <ng-template let-bundle="item">
            <div class="bundle-actions">
                <vdr-dropdown>
                    <button class="btn btn-link btn-sm" vdrDropdownTrigger>
                        <clr-icon shape="ellipsis-vertical"></clr-icon>
                    </button>
                    <vdr-dropdown-menu vdrPosition="bottom-right">
                        <button 
                            type="button" 
                            class="dropdown-item"
                            (click)="onViewBundle(bundle)"
                        >
                            <clr-icon shape="eye" class="mr-2"></clr-icon>
                            View Details
                        </button>
                        <button 
                            type="button" 
                            class="dropdown-item"
                            (click)="onEditBundle(bundle)"
                        >
                            <clr-icon shape="edit" class="mr-2"></clr-icon>
                            Edit Bundle
                        </button>
                        <div class="dropdown-divider"></div>
                        <button 
                            *ngIf="canPublish(bundle)"
                            type="button" 
                            class="dropdown-item"
                            (click)="onPublishBundle(bundle)"
                        >
                            <clr-icon shape="play" class="mr-2"></clr-icon>
                            Publish
                        </button>
                        <button 
                            *ngIf="canArchive(bundle)"
                            type="button" 
                            class="dropdown-item text-danger"
                            (click)="onArchiveBundle(bundle)"
                        >
                            <clr-icon shape="archive" class="mr-2"></clr-icon>
                            Archive
                        </button>
                        <button 
                            *ngIf="canRestore(bundle)"
                            type="button" 
                            class="dropdown-item text-success"
                            (click)="onRestoreBundle(bundle)"
                        >
                            <clr-icon shape="refresh" class="mr-2"></clr-icon>
                            Restore
                        </button>
                    </vdr-dropdown-menu>
                </vdr-dropdown>
            </div>
        </ng-template>
    </vdr-dt2-column>
</vdr-data-table-2>