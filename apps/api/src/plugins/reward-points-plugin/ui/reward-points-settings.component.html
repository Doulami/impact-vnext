<vdr-page-block>
    <vdr-action-bar>
        <vdr-ab-left>
            <div class="page-title">
                <h1>Reward Points Settings</h1>
                <p class="subtitle">Manage customer loyalty rewards and points</p>
            </div>
        </vdr-ab-left>
        <vdr-ab-right>
            <button 
                class="btn btn-secondary" 
                (click)="resetForm()" 
                [disabled]="!settingsForm.dirty">
                <clr-icon shape="refresh"></clr-icon>
                Reset
            </button>
            <button 
                class="btn btn-primary" 
                (click)="saveSettings()" 
                [disabled]="settingsForm.invalid || !settingsForm.dirty">
                <clr-icon shape="check"></clr-icon>
                Save
            </button>
        </vdr-ab-right>
    </vdr-action-bar>
</vdr-page-block>

<vdr-page-detail-layout>
    <vdr-page-detail-sidebar>
        <!-- System Status Card -->
        <vdr-card title="System Status">
            <vdr-form-field label="Current Status" for="status">
                <div class="status-badge">
                    <vdr-chip
                        [colorType]="settingsForm.get('enabled')?.value ? 'success' : 'warning'"
                        [icon]="settingsForm.get('enabled')?.value ? 'check-circle' : 'warning-standard'"
                    >
                        {{ settingsForm.get('enabled')?.value ? 'Enabled' : 'Disabled' }}
                    </vdr-chip>
                </div>
            </vdr-form-field>

            <vdr-labeled-data label="Total customers with points">
                {{ (customerCount$ | async) || 0 | number }} customers
            </vdr-labeled-data>
        </vdr-card>

        <!-- Rate Calculator Card -->
        <vdr-card title="Rate Calculator">
            <vdr-labeled-data label="Example: Earning (for $100 order)">
                <span class="earning-example">
                    {{ calculateExampleEarning() }} points
                </span>
                <small class="text-muted d-block">
                    Points earned on $100 purchase
                </small>
            </vdr-labeled-data>

            <vdr-labeled-data label="Example: Redemption (1000 points)">
                <span class="redemption-example">
                    ${{ calculateExampleRedemption() }}
                </span>
                <small class="text-muted d-block">
                    Discount value of 1000 points
                </small>
            </vdr-labeled-data>
        </vdr-card>

        <!-- Help Card -->
        <vdr-card title="How It Works">
            <p class="text-muted">Configure how customers earn and redeem points</p>
            <ul class="help-list">
                <li>Set earning rate: how many points per dollar spent</li>
                <li>Set redemption rate: discount value per point</li>
                <li>Configure minimum and maximum redemption limits</li>
            </ul>
        </vdr-card>
    </vdr-page-detail-sidebar>

    <vdr-page-block>
        <form [formGroup]="settingsForm">
            <!-- Basic Configuration -->
            <vdr-card title="Basic Configuration">
                <vdr-form-field 
                    label="Enable reward points feature" 
                    for="enabled"
                    tooltip="Toggle to enable/disable the entire reward points system">
                    <clr-toggle-wrapper>
                        <input 
                            type="checkbox" 
                            clrToggle 
                            id="enabled"
                            formControlName="enabled" 
                        />
                        <label for="enabled">
                            Enable Reward Points
                        </label>
                    </clr-toggle-wrapper>
                </vdr-form-field>

                <div class="feature-warning" *ngIf="!settingsForm.get('enabled')?.value">
                    <clr-icon shape="warning-standard" class="warning-icon"></clr-icon>
                    <span>Reward points are currently disabled. Customers cannot earn or redeem points.</span>
                </div>
            </vdr-card>

            <!-- Point Earning Rules -->
            <vdr-card 
                title="Point Earning Rules"
                [paddingX]="true">
                <vdr-form-field 
                    label="Points per dollar" 
                    for="earnRate"
                    tooltip="How many points customers earn per currency unit spent">
                    <div class="rate-input-group">
                        <input 
                            id="earnRate"
                            type="number" 
                            formControlName="earnRate"
                            min="0.001"
                            step="0.1"
                            (blur)="onEarnRateChange()"
                        />
                        <span class="input-suffix">points per dollar</span>
                    </div>
                    <vdr-form-item-error 
                        *ngIf="settingsForm.get('earnRate')?.invalid && settingsForm.get('earnRate')?.touched">
                        Earn rate is required and must be greater than 0
                    </vdr-form-item-error>
                </vdr-form-field>

                <div class="example-calculation">
                    <strong>Example: Earning</strong>
                    <p>Customer earns {{ calculateExampleEarning() }} points for a $100 order</p>
                </div>
            </vdr-card>

            <!-- Point Redemption Rules -->
            <vdr-card 
                title="Point Redemption Rules"
                [paddingX]="true">
                <vdr-form-field 
                    label="Value per point" 
                    for="redeemRate"
                    tooltip="How much currency value each point is worth when redeemed">
                    <div class="rate-input-group">
                        <span class="input-prefix">$</span>
                        <input 
                            id="redeemRate"
                            type="number" 
                            formControlName="redeemRate"
                            min="0.001"
                            step="0.001"
                            (blur)="onEarnRateChange()"
                        />
                        <span class="input-suffix">per point</span>
                    </div>
                    <vdr-form-item-error 
                        *ngIf="settingsForm.get('redeemRate')?.invalid && settingsForm.get('redeemRate')?.touched">
                        Redeem rate is required and must be greater than 0
                    </vdr-form-item-error>
                </vdr-form-field>

                <vdr-form-field 
                    label="Minimum redemption" 
                    for="minRedeemAmount"
                    tooltip="Minimum number of points required before customers can redeem">
                    <div class="rate-input-group">
                        <input 
                            id="minRedeemAmount"
                            type="number" 
                            formControlName="minRedeemAmount"
                            min="1"
                            step="1"
                            (blur)="onMinRedeemAmountChange()"
                        />
                        <span class="input-suffix">points</span>
                    </div>
                    <vdr-form-item-error 
                        *ngIf="settingsForm.get('minRedeemAmount')?.invalid && settingsForm.get('minRedeemAmount')?.touched">
                        Minimum redeem amount is required
                    </vdr-form-item-error>
                </vdr-form-field>

                <vdr-form-field 
                    label="Maximum per order" 
                    for="maxRedeemPerOrder"
                    tooltip="Maximum points that can be redeemed in a single order">
                    <div class="rate-input-group">
                        <input 
                            id="maxRedeemPerOrder"
                            type="number" 
                            formControlName="maxRedeemPerOrder"
                            min="1"
                            step="1"
                            (blur)="onMaxRedeemAmountChange()"
                        />
                        <span class="input-suffix">points</span>
                    </div>
                    <vdr-form-item-error 
                        *ngIf="settingsForm.get('maxRedeemPerOrder')?.invalid && settingsForm.get('maxRedeemPerOrder')?.touched">
                        Maximum redeem amount is required
                    </vdr-form-item-error>
                </vdr-form-field>

                <div class="example-calculation">
                    <strong>Example: Redemption</strong>
                    <p>1000 points = ${{ calculateExampleRedemption() }} discount</p>
                </div>
            </vdr-card>
        </form>
    </vdr-page-block>
</vdr-page-detail-layout>