<vdr-page-block>
    <vdr-action-bar>
        <vdr-ab-left>
            <div class="page-title">
                <h1>{{ isNew ? ('Create bundle' | translate) : (bundle?.name || 'Bundle') }}</h1>
            </div>
        </vdr-ab-left>
        <vdr-ab-right>
            <vdr-action-bar-items locationId="bundle-detail"></vdr-action-bar-items>
            <button class="btn btn-secondary" (click)="cancel()">
                <clr-icon shape="times"></clr-icon>
                Cancel
            </button>
            <button 
                class="btn btn-primary" 
                (click)="save()" 
                [disabled]="bundleForm.invalid || bundleForm.pristine">
                <clr-icon shape="check"></clr-icon>
                {{ isNew ? 'Create bundle' : 'Update' }}
            </button>
            <button 
                *ngIf="!isNew && canPublish()" 
                class="btn btn-success" 
                (click)="publish()">
                <clr-icon shape="play"></clr-icon>
                Publish
            </button>
        </vdr-ab-right>
    </vdr-action-bar>
</vdr-page-block>

<vdr-page-detail-layout>
    <vdr-page-detail-sidebar>
        <!-- Visibility Card -->
        <vdr-card [title]="'Visibility' | translate">
            <vdr-form-field [label]="'Status'" for="status">
                <div class="status-badge">
                    <vdr-chip
                        *ngIf="!isNew"
                        [colorType]="getStatusColor(bundle?.status)"
                        [icon]="getStatusIcon(bundle?.status)"
                    >
                        {{ bundle?.status || 'DRAFT' }}
                    </vdr-chip>
                    <span *ngIf="isNew" class="text-muted">Draft</span>
                </div>
            </vdr-form-field>

            <vdr-form-field *ngIf="!isNew" [label]="'Version'" for="version">
                <span class="version-badge">v{{ bundle?.version || 1 }}</span>
            </vdr-form-field>
        </vdr-card>

        <!-- Facets Card (placeholder for future) -->
        <vdr-card [title]="'Facets' | translate">
            <p class="text-muted">Facet assignment coming soon</p>
        </vdr-card>

        <!-- IDs & Metadata Card -->
        <vdr-card *ngIf="!isNew" [title]="'IDs & Timestamps' | translate">
            <vdr-labeled-data [label]="'ID'">
                <code>{{ bundle?.id }}</code>
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'Created at'">
                {{ bundle?.createdAt | date:'medium' }}
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'Updated at'">
                {{ bundle?.updatedAt | date:'medium' }}
            </vdr-labeled-data>
            <vdr-labeled-data *ngIf="bundle?.lastRecomputedAt" [label]="'Last recomputed'">
                {{ bundle?.lastRecomputedAt | date:'medium' }}
            </vdr-labeled-data>
        </vdr-card>

        <!-- Component Health -->
        <vdr-card *ngIf="!isNew && analytics" [title]="'Component Health' | translate">
            <vdr-labeled-data [label]="'Max available'">
                <span [style.color]="analytics.availabilityStatus?.valid ? '#22c55e' : '#c92100'">
                    {{ analytics.availabilityStatus?.maxQuantityAvailable || 0 }} bundles
                </span>
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'Total savings'">
                <span style="color: #22c55e;">
                    {{ analytics.totalSavings | currency }} ({{ analytics.savingsPercentage | number:'1.1-1' }}%)
                </span>
            </vdr-labeled-data>
        </vdr-card>
    </vdr-page-detail-sidebar>

    <vdr-page-block>
        <form [formGroup]="bundleForm">
            <!-- Bundle Details Section -->
            <vdr-card [title]="'Bundle Details' | translate">
                <vdr-form-field [label]="'Name' | translate" for="name">
                    <input 
                        id="name"
                        type="text" 
                        formControlName="name" 
                        [readonly]="!isNew && !('UpdateBundle' | hasPermission)"
                    />
                </vdr-form-field>

                <vdr-form-field [label]="'Slug' | translate" for="slug" tooltip="URL-friendly identifier">
                    <input 
                        id="slug"
                        type="text" 
                        formControlName="slug"
                    />
                </vdr-form-field>

                <vdr-form-field [label]="'Description' | translate" for="description">
                    <textarea 
                        id="description"
                        formControlName="description" 
                        rows="5"
                    ></textarea>
                </vdr-form-field>

                <vdr-form-field [label]="'Category' | translate" for="category" tooltip="e.g. seasonal, gift-sets">
                    <input 
                        id="category"
                        type="text" 
                        formControlName="category"
                    />
                </vdr-form-field>
            </vdr-card>

            <!-- Pricing & Discount Section -->
            <vdr-card [title]="'Pricing & Discount' | translate">
                <vdr-form-field [label]="'Discount type' | translate" for="discountType">
                    <select 
                        clrSelect
                        id="discountType"
                        formControlName="discountType"
                        (change)="onDiscountTypeChange($event.target.value)"
                    >
                        <option value="fixed">Fixed price</option>
                        <option value="percent">Percentage off</option>
                    </select>
                </vdr-form-field>

                <vdr-form-field
                    *ngIf="bundleForm.get('discountType')?.value === 'fixed'"
                    [label]="'Bundle fixed price' | translate" 
                    for="fixedPrice"
                    tooltip="Price applied at order; item prices prorated">
                    <vdr-currency-input
                        id="fixedPrice"
                        formControlName="fixedPrice"
                        [currencyCode]="(currencyCode$ | async) ?? 'USD'"
                    ></vdr-currency-input>
                </vdr-form-field>

                <vdr-form-field
                    *ngIf="bundleForm.get('discountType')?.value === 'percent'"
                    [label]="'Percentage off' | translate" 
                    for="percentOff"
                    tooltip="Discount percentage (0-100)">
                    <input 
                        id="percentOff"
                        type="number" 
                        formControlName="percentOff"
                        min="0"
                        max="100"
                        step="1"
                    />
                </vdr-form-field>
            </vdr-card>

            <!-- Availability Section -->
            <vdr-card [title]="'Availability' | translate">
                <vdr-form-field [label]="'Available from' | translate" for="validFrom" tooltip="Leave empty for immediate availability">
                    <vdr-datetime-picker
                        id="validFrom"
                        formControlName="validFrom"
                    ></vdr-datetime-picker>
                </vdr-form-field>

                <vdr-form-field [label]="'Available until' | translate" for="validTo" tooltip="Leave empty for permanent availability">
                    <vdr-datetime-picker
                        id="validTo"
                        formControlName="validTo"
                    ></vdr-datetime-picker>
                </vdr-form-field>

                <vdr-form-field [label]="'Bundle cap' | translate" for="bundleCap" tooltip="Maximum bundles that can be sold">
                    <input 
                        id="bundleCap"
                        type="number" 
                        formControlName="bundleCap"
                        min="0"
                        step="1"
                    />
                </vdr-form-field>
                
                <!-- Promotion Policy Section -->
                <vdr-form-field 
                    [label]="'Allow external promotions' | translate" 
                    for="allowExternalPromos"
                    tooltip="Allow external promotion codes/coupons to be applied to this bundle">
                    <clr-toggle-wrapper>
                        <input 
                            type="checkbox" 
                            clrToggle 
                            id="allowExternalPromos"
                            formControlName="allowExternalPromos"
                        />
                    </clr-toggle-wrapper>
                    <div class="help-text" style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                        <p style="margin: 0.25rem 0;">
                            <strong>OFF:</strong> Promotion codes and coupons will NOT apply to this bundle (prevents double-discounting).
                        </p>
                        <p style="margin: 0.25rem 0;">
                            <strong>ON:</strong> External promotions can apply (bundle discount + promo discount).
                        </p>
                    </div>
                </vdr-form-field>

                <!-- Phase 2 v3: Reservation System Display (Read-only) -->
                <vdr-form-field 
                    *ngIf="!isNew && bundle?.bundleCap" 
                    [label]="'Reserved (Open)' | translate" 
                    for="bundleReservedOpen"
                    tooltip="Bundles in paid-but-not-shipped orders">
                    <div class="reservation-status">
                        <span class="reserved-count">{{ bundle?.bundleReservedOpen || 0 }}</span>
                        <span class="text-muted ml-2" style="font-size: 0.9em;">(read-only)</span>
                    </div>
                </vdr-form-field>

                <vdr-form-field 
                    *ngIf="!isNew && bundle?.bundleCap" 
                    [label]="'Virtual Stock' | translate" 
                    for="bundleVirtualStock"
                    tooltip="Available capacity: max(0, Cap - Reserved)">
                    <div class="virtual-stock-status">
                        <span 
                            class="virtual-stock-count"
                            [style.color]="getVirtualStockColor()"
                        >
                            {{ bundle?.bundleVirtualStock ?? 'N/A' }}
                        </span>
                        <span *ngIf="isOverbooked()" style="color: #c92100; margin-left: 0.5rem; font-size: 0.9em;">
                            ⚠️ OVERBOOKED
                        </span>
                        <span style="color: #6c757d; margin-left: 0.5rem; font-size: 0.9em;">(computed)</span>
                    </div>
                </vdr-form-field>
            </vdr-card>

        <!-- Assets Section -->
        <vdr-card [title]="'Assets' | translate">
            <vdr-assets
                [assets]="assetChanges.assets"
                [featuredAsset]="assetChanges.featuredAsset"
                (change)="onAssetChange($event)"
            ></vdr-assets>
        </vdr-card>

        <!-- Bundle Items Section -->
        <vdr-card [title]="'Bundle Items' | translate">
            <button 
                type="button" 
                class="btn btn-sm btn-success mb-3" 
                (click)="addBundleItem()">
                <clr-icon shape="plus"></clr-icon>
                Add item
            </button>

            <table class="table" formArrayName="items">
                <thead>
                    <tr>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Unit price</th>
                        <th>Weight</th>
                        <th>Display order</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                        <td>
                            <div style="position: relative;">
                                <input 
                                    #variantInput
                                    type="text"
                                    class="form-control form-control-sm"
                                    placeholder="Search variant..."
                                    [value]="item.get('productVariantName')?.value"
                                    (input)="searchVariants(($any($event).target).value, i)"
                                    (focus)="activeSearchIndex = i"
                                />
                            </div>
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="quantity"
                                class="form-control form-control-sm"
                                min="1"
                                style="width: 80px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="unitPrice"
                                class="form-control form-control-sm"
                                min="0"
                                step="0.01"
                                style="width: 100px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="weight"
                                class="form-control form-control-sm"
                                min="0"
                                step="0.01"
                                style="width: 80px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="displayOrder"
                                class="form-control form-control-sm"
                                min="0"
                                style="width: 60px;"
                            />
                        </td>
                        <td>
                            <button 
                                type="button"
                                class="btn btn-sm btn-danger"
                                (click)="removeBundleItem(i)"
                            >
                                <clr-icon shape="times"></clr-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Variant search dropdown (outside table to avoid overflow issues) -->
            <div *ngIf="variantSearchResults.length > 0 && activeSearchIndex !== null" 
                 style="position: fixed; z-index: 9999; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; min-width: 400px;">
                <button 
                    *ngFor="let variant of variantSearchResults"
                    type="button"
                    class="dropdown-item"
                    (click)="selectVariant(variant, activeSearchIndex)"
                    style="display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: white; cursor: pointer; border-bottom: 1px solid #f0f0f0;"
                    (mouseenter)="$event.target.style.backgroundColor = '#f5f5f5'"
                    (mouseleave)="$event.target.style.backgroundColor = 'white'"
                >
                    <strong>{{ variant.productVariantName }}</strong>
                    <br>
                    <small class="text-muted">SKU: {{ variant.sku }}</small>
                    <small class="text-muted ml-2">{{ variant.price.value / 100 | currency }}</small>
                </button>
            </div>
        </vdr-card>

        <!-- Custom Fields (Read-only computed) -->
        <vdr-card *ngIf="!isNew" [title]="'Computed Fields' | translate">
            <vdr-form-field [label]="'Bundle price (computed)'" for="computedPrice">
                <input 
                    id="computedPrice"
                    type="text" 
                    [value]="(bundle?.effectivePrice || 0) / 100 | currency"
                    readonly
                    disabled
                    class="text-muted"
                />
            </vdr-form-field>

            <vdr-form-field [label]="'Shell product ID'" for="shellProductId">
                <input 
                    id="shellProductId"
                    type="text" 
                    [value]="bundle?.shellProductId || 'Not created'"
                    readonly
                    disabled
                    class="text-muted"
                />
            </vdr-form-field>
            </vdr-card>
        </form>
    </vdr-page-block>
</vdr-page-detail-layout>
