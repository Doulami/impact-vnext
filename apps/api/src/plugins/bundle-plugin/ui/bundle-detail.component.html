<vdr-page-block>
    <vdr-action-bar>
        <vdr-ab-left>
            <div class="page-title">
                <h1>{{ isNew ? ('bundle-plugin.create-bundle' | translate) : (bundle?.name || 'Bundle') }}</h1>
            </div>
        </vdr-ab-left>
        <vdr-ab-right>
            <vdr-action-bar-items locationId="bundle-detail"></vdr-action-bar-items>
            <button class="btn btn-secondary" (click)="cancel()">
                <clr-icon shape="times"></clr-icon>
                {{ 'bundle-plugin.cancel' | translate }}
            </button>
            <button 
                class="btn btn-primary" 
                (click)="save()" 
                [disabled]="bundleForm.invalid || bundleForm.pristine">
                <clr-icon shape="check"></clr-icon>
                {{ isNew ? ('bundle-plugin.create-bundle' | translate) : ('bundle-plugin.update-bundle' | translate) }}
            </button>
            <button 
                *ngIf="!isNew && canPublish()" 
                class="btn btn-success" 
                (click)="publish()">
                <clr-icon shape="play"></clr-icon>
                {{ 'bundle-plugin.publish' | translate }}
            </button>
        </vdr-ab-right>
    </vdr-action-bar>
</vdr-page-block>

<vdr-page-detail-layout>
    <vdr-page-detail-sidebar>
        <!-- Visibility Card -->
        <vdr-card [title]="'bundle-plugin.visibility' | translate">
            <vdr-form-field [label]="'bundle-plugin.status' | translate" for="status">
                <div class="status-badge">
                    <vdr-chip
                        *ngIf="!isNew"
                        [colorType]="getStatusColor(bundle?.status)"
                        [icon]="getStatusIcon(bundle?.status)"
                    >
                        {{ bundle?.status || 'DRAFT' }}
                    </vdr-chip>
                    <span *ngIf="isNew" class="text-muted">{{ 'bundle-plugin.draft' | translate }}</span>
                </div>
            </vdr-form-field>

            <vdr-form-field *ngIf="!isNew" [label]="'bundle-plugin.version' | translate" for="version">
                <span class="version-badge">v{{ bundle?.version || 1 }}</span>
            </vdr-form-field>
        </vdr-card>

        <!-- Facets Card (placeholder for future) -->
        <vdr-card [title]="'bundle-plugin.facets' | translate">
            <p class="text-muted">{{ 'bundle-plugin.facet-assignment-coming-soon' | translate }}</p>
        </vdr-card>

        <!-- IDs & Metadata Card -->
        <vdr-card *ngIf="!isNew" [title]="'bundle-plugin.ids-timestamps' | translate">
            <vdr-labeled-data [label]="'bundle-plugin.id' | translate">
                <code>{{ bundle?.id }}</code>
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'bundle-plugin.created-at' | translate">
                {{ bundle?.createdAt | date:'medium' }}
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'bundle-plugin.updated-at' | translate">
                {{ bundle?.updatedAt | date:'medium' }}
            </vdr-labeled-data>
            <vdr-labeled-data *ngIf="bundle?.lastRecomputedAt" [label]="'bundle-plugin.last-recomputed' | translate">
                {{ bundle?.lastRecomputedAt | date:'medium' }}
            </vdr-labeled-data>
        </vdr-card>

        <!-- Component Health -->
        <vdr-card *ngIf="!isNew && analytics" [title]="'bundle-plugin.component-health' | translate">
            <vdr-labeled-data [label]="'bundle-plugin.max-available' | translate">
                <span [style.color]="analytics.availabilityStatus?.valid ? '#22c55e' : '#c92100'">
                    {{ analytics.availabilityStatus?.maxQuantityAvailable || 0 }} bundles
                </span>
            </vdr-labeled-data>
            <vdr-labeled-data [label]="'bundle-plugin.total-savings' | translate">
                <span style="color: #22c55e;">
                    {{ analytics.totalSavings | currency }} ({{ analytics.savingsPercentage | number:'1.1-1' }}%)
                </span>
            </vdr-labeled-data>
        </vdr-card>
    </vdr-page-detail-sidebar>

    <vdr-page-block>
        <form [formGroup]="bundleForm">
            <!-- Bundle Details Section -->
            <vdr-card [title]="'bundle-plugin.bundle-details' | translate">
                <vdr-form-field [label]="'bundle-plugin.name' | translate" for="name">
                    <input 
                        id="name"
                        type="text" 
                        formControlName="name" 
                        [readonly]="!isNew && !('UpdateBundle' | hasPermission)"
                    />
                </vdr-form-field>

                <vdr-form-field [label]="'bundle-plugin.slug' | translate" for="slug" [tooltip]="'bundle-plugin.url-friendly-identifier' | translate">
                    <input 
                        id="slug"
                        type="text" 
                        formControlName="slug"
                    />
                </vdr-form-field>

                <vdr-form-field [label]="'bundle-plugin.description' | translate" for="description">
                    <textarea 
                        id="description"
                        formControlName="description" 
                        rows="5"
                    ></textarea>
                </vdr-form-field>

                <vdr-form-field [label]="'bundle-plugin.category' | translate" for="category" [tooltip]="'bundle-plugin.eg-seasonal-gift-sets' | translate">
                    <input 
                        id="category"
                        type="text" 
                        formControlName="category"
                    />
                </vdr-form-field>
            </vdr-card>

            <!-- Pricing & Discount Section -->
            <vdr-card [title]="'bundle-plugin.pricing-discount' | translate">
                <vdr-form-field [label]="'bundle-plugin.discount-type' | translate" for="discountType">
                    <select 
                        clrSelect
                        id="discountType"
                        formControlName="discountType"
                        (change)="onDiscountTypeChange($event.target.value)"
                    >
                        <option value="fixed">{{ 'bundle-plugin.fixed-price' | translate }}</option>
                        <option value="percent">{{ 'bundle-plugin.percentage-off' | translate }}</option>
                    </select>
                </vdr-form-field>

                <vdr-form-field
                    *ngIf="bundleForm.get('discountType')?.value === 'fixed'"
                    [label]="'bundle-plugin.bundle-fixed-price' | translate" 
                    for="fixedPrice"
                    [tooltip]="'bundle-plugin.price-applied-at-order' | translate">
                    <vdr-currency-input
                        id="fixedPrice"
                        formControlName="fixedPrice"
                        [currencyCode]="(currencyCode$ | async) ?? 'USD'"
                    ></vdr-currency-input>
                </vdr-form-field>

                <vdr-form-field
                    *ngIf="bundleForm.get('discountType')?.value === 'percent'"
                    [label]="'bundle-plugin.percentage-off' | translate" 
                    for="percentOff"
                    [tooltip]="'bundle-plugin.discount-percentage-0-100' | translate">
                    <input 
                        id="percentOff"
                        type="number" 
                        formControlName="percentOff"
                        min="0"
                        max="100"
                        step="1"
                    />
                </vdr-form-field>
            </vdr-card>

            <!-- Availability Section -->
            <vdr-card [title]="'bundle-plugin.availability' | translate">
                <vdr-form-field [label]="'bundle-plugin.available-from' | translate" for="validFrom" [tooltip]="'bundle-plugin.leave-empty-immediate' | translate">
                    <vdr-datetime-picker
                        id="validFrom"
                        formControlName="validFrom"
                    ></vdr-datetime-picker>
                </vdr-form-field>

                <vdr-form-field [label]="'bundle-plugin.available-until' | translate" for="validTo" [tooltip]="'bundle-plugin.leave-empty-permanent' | translate">
                    <vdr-datetime-picker
                        id="validTo"
                        formControlName="validTo"
                    ></vdr-datetime-picker>
                </vdr-form-field>

                <vdr-form-field [label]="'bundle-plugin.bundle-cap' | translate" for="bundleCap" [tooltip]="'bundle-plugin.maximum-bundles-that-can-be-sold' | translate">
                    <input 
                        id="bundleCap"
                        type="number" 
                        formControlName="bundleCap"
                        min="0"
                        step="1"
                    />
                </vdr-form-field>
                
                <!-- Promotion Policy Section -->
                <vdr-form-field 
                    [label]="'bundle-plugin.allow-external-promotions' | translate" 
                    for="allowExternalPromos"
                    [tooltip]="'bundle-plugin.allow-external-promos-tooltip' | translate">
                    <clr-toggle-wrapper>
                        <input 
                            type="checkbox" 
                            clrToggle 
                            id="allowExternalPromos"
                            formControlName="allowExternalPromos"
                        />
                    </clr-toggle-wrapper>
                    <div class="help-text" style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                        <p style="margin: 0.25rem 0;">
                            <strong>OFF:</strong> {{ 'bundle-plugin.allow-external-promos-help-off' | translate }}
                        </p>
                        <p style="margin: 0.25rem 0;">
                            <strong>ON:</strong> {{ 'bundle-plugin.allow-external-promos-help-on' | translate }}
                        </p>
                    </div>
                </vdr-form-field>

                <!-- Phase 2 v3: Reservation System Display (Read-only) -->
                <vdr-form-field 
                    *ngIf="!isNew && bundle?.bundleCap" 
                    [label]="'bundle-plugin.reserved-open' | translate" 
                    for="bundleReservedOpen"
                    [tooltip]="'bundle-plugin.reserved-open-tooltip' | translate">
                    <div class="reservation-status">
                        <span class="reserved-count">{{ bundle?.bundleReservedOpen || 0 }}</span>
                        <span class="text-muted ml-2" style="font-size: 0.9em;">{{ 'bundle-plugin.read-only' | translate }}</span>
                    </div>
                </vdr-form-field>

                <vdr-form-field 
                    *ngIf="!isNew && bundle?.bundleCap" 
                    [label]="'bundle-plugin.virtual-stock' | translate" 
                    for="bundleVirtualStock"
                    [tooltip]="'bundle-plugin.virtual-stock-tooltip' | translate">
                    <div class="virtual-stock-status">
                        <span 
                            class="virtual-stock-count"
                            [style.color]="getVirtualStockColor()"
                        >
                            {{ bundle?.bundleVirtualStock ?? 'N/A' }}
                        </span>
                        <span *ngIf="isOverbooked()" style="color: #c92100; margin-left: 0.5rem; font-size: 0.9em;">
                            ⚠️ {{ 'bundle-plugin.overbooked' | translate }}
                        </span>
                        <span style="color: #6c757d; margin-left: 0.5rem; font-size: 0.9em;">{{ 'bundle-plugin.computed' | translate }}</span>
                    </div>
                </vdr-form-field>
            </vdr-card>

        <!-- Assets Section -->
        <vdr-card [title]="'bundle-plugin.assets' | translate">
            <vdr-assets
                [assets]="assetChanges.assets"
                [featuredAsset]="assetChanges.featuredAsset"
                (change)="onAssetChange($event)"
            ></vdr-assets>
        </vdr-card>

        <!-- Bundle Items Section -->
        <vdr-card [title]="'bundle-plugin.bundle-items' | translate">
            <button 
                type="button" 
                class="btn btn-sm btn-success mb-3" 
                (click)="addBundleItem()">
                <clr-icon shape="plus"></clr-icon>
                {{ 'bundle-plugin.add-item' | translate }}
            </button>

            <table class="table" formArrayName="items">
                <thead>
                    <tr>
                        <th>{{ 'bundle-plugin.variant' | translate }}</th>
                        <th>{{ 'bundle-plugin.quantity' | translate }}</th>
                        <th>{{ 'bundle-plugin.unit-price' | translate }}</th>
                        <th>{{ 'bundle-plugin.weight' | translate }}</th>
                        <th>{{ 'bundle-plugin.display-order' | translate }}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                        <td>
                            <div style="position: relative;">
                                <input 
                                    #variantInput
                                    type="text"
                                    class="form-control form-control-sm"
                                    [placeholder]="'bundle-plugin.search-variant' | translate"
                                    [value]="item.get('productVariantName')?.value"
                                    (input)="searchVariants(($any($event).target).value, i)"
                                    (focus)="activeSearchIndex = i"
                                />
                            </div>
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="quantity"
                                class="form-control form-control-sm"
                                min="1"
                                style="width: 80px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="unitPrice"
                                class="form-control form-control-sm"
                                min="0"
                                step="0.01"
                                style="width: 100px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="weight"
                                class="form-control form-control-sm"
                                min="0"
                                step="0.01"
                                style="width: 80px;"
                            />
                        </td>
                        <td>
                            <input 
                                type="number" 
                                formControlName="displayOrder"
                                class="form-control form-control-sm"
                                min="0"
                                style="width: 60px;"
                            />
                        </td>
                        <td>
                            <button 
                                type="button"
                                class="btn btn-sm btn-danger"
                                (click)="removeBundleItem(i)"
                            >
                                <clr-icon shape="times"></clr-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Variant search dropdown (outside table to avoid overflow issues) -->
            <div *ngIf="variantSearchResults.length > 0 && activeSearchIndex !== null" 
                 style="position: fixed; z-index: 9999; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; min-width: 400px;">
                <button 
                    *ngFor="let variant of variantSearchResults"
                    type="button"
                    class="dropdown-item"
                    (click)="selectVariant(variant, activeSearchIndex)"
                    style="display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: white; cursor: pointer; border-bottom: 1px solid #f0f0f0;"
                    (mouseenter)="$event.target.style.backgroundColor = '#f5f5f5'"
                    (mouseleave)="$event.target.style.backgroundColor = 'white'"
                >
                    <strong>{{ variant.productVariantName }}</strong>
                    <br>
                    <small class="text-muted">{{ 'bundle-plugin.sku' | translate }}: {{ variant.sku }}</small>
                    <small class="text-muted ml-2">{{ variant.price.value / 100 | currency }}</small>
                </button>
            </div>
        </vdr-card>

        <!-- Custom Fields (Read-only computed) -->
        <vdr-card *ngIf="!isNew" [title]="'bundle-plugin.computed-fields' | translate">
            <vdr-form-field [label]="'bundle-plugin.bundle-price-computed' | translate" for="computedPrice">
                <input 
                    id="computedPrice"
                    type="text" 
                    [value]="(bundle?.effectivePrice || 0) / 100 | currency"
                    readonly
                    disabled
                    class="text-muted"
                />
            </vdr-form-field>

            <vdr-form-field [label]="'bundle-plugin.shell-product-id' | translate" for="shellProductId">
                <input 
                    id="shellProductId"
                    type="text" 
                    [value]="bundle?.shellProductId || ('bundle-plugin.not-created' | translate)"
                    readonly
                    disabled
                    class="text-muted"
                />
            </vdr-form-field>
            </vdr-card>
        </form>
    </vdr-page-block>
</vdr-page-detail-layout>
