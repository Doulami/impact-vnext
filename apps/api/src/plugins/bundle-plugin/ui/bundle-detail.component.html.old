<vdr-page-block>
    <vdr-action-bar>
        <vdr-ab-left>
            <vdr-page-title [title]="isNew ? 'Create Bundle' : bundle?.name"></vdr-page-title>
        </vdr-ab-left>
        <vdr-ab-right>
            <button class="btn btn-secondary" (click)="cancel()">
                <clr-icon shape="times"></clr-icon>
                Cancel
            </button>
            <button class="btn btn-primary" (click)="save()" [disabled]="bundleForm.invalid">
                <clr-icon shape="check"></clr-icon>
                {{ isNew ? 'Create' : 'Update' }}
            </button>
            <button *ngIf="!isNew" class="btn btn-danger" (click)="delete()">
                <clr-icon shape="trash"></clr-icon>
                Delete
            </button>
        </vdr-ab-right>
    </vdr-action-bar>
</vdr-page-block>

<form [formGroup]="bundleForm" class="form">
    <div class="detail-form">
        <div class="left-column">
            <vdr-page-block>
                <vdr-card [title]="'Bundle Details'">
                    <div class="clr-form-control">
                        <label class="clr-control-label required">Name</label>
                        <input
                            type="text"
                            formControlName="name"
                            class="clr-input"
                            placeholder="Enter bundle name"
                        />
                    </div>

                    <div class="clr-form-control">
                        <label class="clr-control-label">Slug</label>
                        <input
                            type="text"
                            formControlName="slug"
                            class="clr-input"
                            placeholder="bundle-slug (optional)"
                        />
                    </div>

                    <div class="clr-form-control">
                        <label class="clr-control-label">Description</label>
                        <textarea
                            formControlName="description"
                            class="clr-textarea"
                            rows="4"
                            placeholder="Enter bundle description"
                        ></textarea>
                    </div>
                </vdr-card>
            </vdr-page-block>

            <vdr-page-block>
                <vdr-card [title]="'Assets'">
                    <div class="assets-section">
                        <div class="asset-gallery">
                            <div class="add-asset-button">
                                <clr-icon shape="plus"></clr-icon>
                                <span>Add asset</span>
                            </div>
                        </div>
                        <p class="help-text">Add images for this bundle</p>
                    </div>
                </vdr-card>
            </vdr-page-block>
        </div>

        <div class="right-column">
            <vdr-page-block>
                <vdr-card [title]="'Bundle Options'">
                    <div class="clr-form-control">
                        <label class="clr-control-label required">Price</label>
                        <input
                            type="number"
                            formControlName="price"
                            class="clr-input"
                            min="0"
                            step="0.01"
                            placeholder="0.00"
                        />
                    </div>

                    <div class="clr-form-control">
                        <label class="clr-control-label">Category</label>
                        <input
                            type="text"
                            formControlName="category"
                            class="clr-input"
                            placeholder="e.g. seasonal, gift-sets"
                        />
                    </div>

                    <div class="visibility-toggle">
                        <label class="clr-control-label">Visibility</label>
                        <div class="toggle-wrapper">
                            <input
                                type="checkbox"
                                formControlName="enabled"
                                class="clr-checkbox"
                            />
                            <span>{{ bundleForm.get('enabled')?.value ? 'Enabled' : 'Disabled' }}</span>
                        </div>
                    </div>
                </vdr-card>
            </vdr-page-block>

            <vdr-page-block>
                <vdr-card [title]="'Facets'">
                    <div class="facets-section">
                        <div class="facet-values">
                            <span class="facet-pill">CATEGORY: Home & Garden</span>
                            <span class="facet-pill">CATEGORY: Furniture</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-link add-facets-btn">
                            <clr-icon shape="plus"></clr-icon>
                            Add facets
                        </button>
                    </div>
                </vdr-card>
            </vdr-page-block>
        </div>
    </div>

    <vdr-page-block class="full-width">
        <vdr-card [title]="'Bundle Items'">
            <div class="bundle-items-header">
                <button type="button" class="btn btn-sm btn-success" (click)="addBundleItem()">
                    <clr-icon shape="plus"></clr-icon>
                    Add Item
                </button>
                <p class="help-text">
                    Add product variants to this bundle. Each bundle must have at least one item (max 10).
                </p>
            </div>

            <vdr-data-table
                *ngIf="items.length > 0"
                [items]="getItemsForTable()"
                [itemsPerPage]="50"
                [showPaging]="false"
                formArrayName="items"
            >
                <vdr-dt-column>IMAGE
                    <ng-template let-item="item" let-index="index">
                        <div class="product-image-placeholder">
                            <clr-icon shape="image"></clr-icon>
                        </div>
                    </ng-template>
                </vdr-dt-column>

                <vdr-dt-column [expand]="true">PRODUCT VARIANT
                    <ng-template let-item="item" let-index="index">
                        <div [formGroupName]="index">
                            <div *ngIf="!item.productVariantId" class="variant-selector-wrapper">
                                <vdr-product-variant-selector
                                    (productSelected)="onProductVariantSelected($event, index)">
                                </vdr-product-variant-selector>
                                <span class="search-hint">Search by product name or SKU</span>
                            </div>
                            <div *ngIf="item.productVariantId" class="selected-variant-inline">
                                <div class="variant-name">{{ item.productVariantName }}</div>
                                <div class="sku-line">SKU: {{ item.productVariantSku }}</div>
                                <button
                                    type="button"
                                    class="btn btn-xs btn-link change-variant-btn"
                                    (click)="clearVariant(index)"
                                >
                                    Change
                                </button>
                            </div>
                        </div>
                    </ng-template>
                </vdr-dt-column>

                <vdr-dt-column>QUANTITY
                    <ng-template let-item="item" let-index="index">
                        <div [formGroupName]="index">
                            <input
                                type="number"
                                formControlName="quantity"
                                class="clr-input table-input"
                                min="1"
                                placeholder="1"
                            />
                        </div>
                    </ng-template>
                </vdr-dt-column>

                <vdr-dt-column>UNIT PRICE
                    <ng-template let-item="item" let-index="index">
                        <div [formGroupName]="index">
                            <input
                                type="number"
                                formControlName="unitPrice"
                                class="clr-input table-input"
                                min="0"
                                step="0.01"
                                placeholder="0.00"
                            />
                        </div>
                    </ng-template>
                </vdr-dt-column>

                <vdr-dt-column>ORDER
                    <ng-template let-item="item" let-index="index">
                        <div [formGroupName]="index">
                            <input
                                type="number"
                                formControlName="displayOrder"
                                class="clr-input table-input"
                                min="0"
                                placeholder="0"
                            />
                        </div>
                    </ng-template>
                </vdr-dt-column>

                <vdr-dt-column>
                    <ng-template let-item="item" let-index="index">
                        <button
                            type="button"
                            class="btn btn-sm btn-danger-outline"
                            (click)="removeBundleItem(index)"
                            title="Remove item"
                        >
                            <clr-icon shape="trash"></clr-icon>
                        </button>
                    </ng-template>
                </vdr-dt-column>
            </vdr-data-table>

            <div *ngIf="items.length === 0" class="empty-state">
                <clr-icon shape="layers" size="48"></clr-icon>
                <h3>No bundle items</h3>
                <p>Add product variants to create your bundle</p>
                <button type="button" class="btn btn-primary" (click)="addBundleItem()">
                    <clr-icon shape="plus"></clr-icon>
                    Add First Item
                </button>
            </div>
        </vdr-card>
    </vdr-page-block>

    <vdr-page-block *ngIf="!isNew && analytics">
        <vdr-card [title]="'Bundle Analytics'">
            <div class="analytics-grid">
                <div class="analytics-item">
                    <div class="label">Total Components</div>
                    <div class="value">{{ analytics.totalComponents }}</div>
                </div>
                <div class="analytics-item">
                    <div class="label">Component Total</div>
                    <div class="value">{{ analytics.componentTotal | currency }}</div>
                </div>
                <div class="analytics-item">
                    <div class="label">Bundle Price</div>
                    <div class="value">{{ analytics.bundlePrice | currency }}</div>
                </div>
                <div class="analytics-item">
                    <div class="label">Total Savings</div>
                    <div class="value savings">{{ analytics.totalSavings | currency }}</div>
                </div>
                <div class="analytics-item">
                    <div class="label">Savings Percentage</div>
                    <div class="value savings">{{ analytics.savingsPercentage | number:'1.2-2' }}%</div>
                </div>
            </div>

            <div class="stock-validation" *ngIf="analytics.availabilityStatus">
                <h4>Stock Availability</h4>
                <div class="validation-status" [class.valid]="analytics.availabilityStatus.valid" [class.invalid]="!analytics.availabilityStatus.valid">
                    <clr-icon [attr.shape]="analytics.availabilityStatus.valid ? 'check-circle' : 'exclamation-circle'"></clr-icon>
                    <span *ngIf="analytics.availabilityStatus.valid">
                        In Stock - Max {{ analytics.availabilityStatus.maxQuantityAvailable }} available
                    </span>
                    <span *ngIf="!analytics.availabilityStatus.valid">
                        {{ analytics.availabilityStatus.message }}
                    </span>
                </div>
                <div *ngIf="analytics.availabilityStatus.constrainingVariants.length > 0" class="constraining-variants">
                    <strong>Constraining Variants:</strong>
                    <ul>
                        <li *ngFor="let variant of analytics.availabilityStatus.constrainingVariants">
                            {{ variant.name }}
                        </li>
                    </ul>
                </div>
            </div>
        </vdr-card>
    </vdr-page-block>
</form>
