# Operations Runbook\n\n## Feature Flags: Toggle from Strapi\n\n### Prerequisites\n- Strapi admin access\n- Knowledge of flag effects (see store-config.md)\n\n### Steps\n\n1. **Log in** to Strapi admin (http://cms:1337/admin)\n2. **Navigate** to \"Content Manager\" → \"StoreConfig\" (single-type)\n3. **Locate** feature toggle group (e.g., \"Features\")\n4. **Toggle** desired flag (e.g., `payments.gpgEnabled`)\n5. **Review** flag semantics (see table below)\n6. **Publish** changes (click \"Publish\" button)\n7. **Verify**: \n   - API cache invalidated (5–10 min max)\n   - Storefront reloads flag (30 min cache; manual refresh clears)\n\n### Flag Semantics Quick Reference\n\n| Flag | When OFF | When ON |\n|------|----------|----------|\n| `payments.gpgEnabled` | GPG payment method hidden; checkout uses fallback | GPG option shown; customer redirected to GPG hosted page |\n| `shipping.fileBridgeEnabled` | No auto-export; orders stay \"Pending Fulfillment\" | Auto-export on \"Ready to Ship\" schedule |\n| `loyalty` | No loyalty UI or calculation | Points earned on orders; redeemable at checkout |\n| `search.meiliEnabled` | Fallback to basic API filter (title/SKU/tag) | Full-text search with typo tolerance |\n| `pwa.enabled` | No install prompt | PWA install prompt shown on home |\n| `cache.edgeEnabled` | Standard Cache-Control; no surrogate purge | Smart cache purge on catalog changes |\n\n### Rollback\nIf toggle causes issues:\n1. Return to Strapi StoreConfig\n2. Toggle flag back to original state\n3. Publish\n4. Wait 5–10 min for API cache invalidation\n5. Verify storefront behavior restored\n\n---\n\n## Cache Purge Steps (Cloudflare Edge, if enabled)\n\n### Scenario: Product price changed; CF cache stale\n\n### Via API Plugin (Automatic)\n- **Trigger**: Vendure product mutation → plugin listens → calls CF Purge API\n- **Surrogate keys**: `product-${productId}`, related collection keys\n- **Latency**: <2s typical\n- **Verification**: check CF Analytics dashboard (hit ratio should dip briefly, then recover)\n\n### Manual Purge (Future Admin UI)\n1. Navigate to Admin → Cache section (M10 future)\n2. Select \"Purge\" option\n3. Choose scope: \"All\", \"Product\", \"Collection\"\n4. Confirm + submit\n5. Verify: CF dashboard shows purge event\n\n### Monitoring\n- **Alert**: if purge latency >5s or failure rate >5%, investigate plugin logs\n- **Dashboard**: CF Analytics → Caching tab → check cache hit ratio\n\n---\n\n## Shipping File Export: Manual Trigger\n\n### Prerequisites\n- Vendure admin access\n- Orders in \"Ready to Ship\" state (or waiting to re-export)\n- SFTP/HTTPS credentials configured\n\n### Steps\n\n1. **Log in** to Vendure admin (http://api:3000/admin)\n2. **Navigate** to \"Orders\" section (future admin UI; currently API-only)\n3. **Click** \"Export Shipping\" button (or call API endpoint manually)\n   - Endpoint: `POST /admin/orders/export-shipping`\n   - Query params: `?dateRange=last24h` or `?orderIds=ORD-001,ORD-002`\n4. **System generates** CSV file with order data\n5. **Upload** via SFTP or HTTPS (configured in env vars)\n6. **Verify** response:\n   - Success: batch ID returned, status \"success\"\n   - Failure: error message + retry instructions\n7. **Check logs**: `/api/logs` or CloudWatch (if deployed)\n   - Log entry: \"Export batch [ID] started\"\n   - Upload: \"Uploaded [filename] to [host]\"\n   - Result: \"Batch [ID] completed successfully\" or error details\n\n### Re-Export (Idempotent)\n\nIf export failed or order needs to be re-shipped:\n\n1. **Identify** batch ID or order IDs to re-export\n2. **Call** API with same orders:\n   - `POST /admin/orders/export-shipping?batchId=exp-20241104-1`\n3. **System marks** previous batch as \"superseded\"\n4. **Create** new batch ID; upload file\n5. **Verify**: remote system deduplicates by order_id\n\n### Monitoring\n- **Alerts**: export failure (batch marked \"Failed\"), upload latency >2 min\n- **Logs**: all export events logged; searchable by batch ID\n- **Manual fix**: if SFTP credentials invalid, update `SHIP_REMOTE_*` env vars and restart API\n\n---\n\n## Webhook Replay: GPG Payment Reconciliation\n\n### Scenario: Payment webhook lost; order stuck in \"Authorized\"\n\n### Steps\n\n1. **Identify** order with stuck payment state\n   - Vendure admin: order detail → Payment tab\n   - Status: \"Authorized\"; timestamp >24h old\n   - Transaction ID: `gpg-txn-789`\n\n2. **Verify** in GPG dashboard:\n   - Log in to GPG merchant portal\n   - Search transaction by ID\n   - Check status: \"Captured\", \"Failed\", \"Refunded\", etc.\n\n3. **Determine action**:\n   - If GPG shows \"Captured\" but Vendure \"Authorized\" → manual capture needed\n   - If GPG shows \"Authorized\" still → contact GPG support or wait\n   - If GPG shows \"Failed\" but Vendure \"Authorized\" → data inconsistency; escalate\n\n4. **Replay webhook** (if GPG shows \"Captured\"):\n   - Call admin API endpoint: `POST /admin/webhooks/gpg/replay`\n   - Params: `transactionId=gpg-txn-789`\n   - System validates signature, updates payment state → \"Captured\"\n   - Order transitions to fulfillment workflow\n\n5. **Alternative: Manual Capture** (if replay not available):\n   - Vendure admin: order detail → Payment tab\n   - Click \"Capture Payment\" button (future M8)\n   - Confirm dialog: \"Capture $X.XX?\"\n   - System transitions order to \"Captured\"; email sent\n\n### Monitoring\n- **Daily reconciliation**: list all orders in \"Authorized\" state >24h; check for issues\n- **Alerts**: if >5 stuck orders, investigate webhook reliability\n- **Logs**: `/api/logs/webhooks` → search for failed signature validations\n\n---\n\n## Payment Reconciliation Checklist\n\n**Run daily at 8 AM (or on-demand)**\n\n### Morning Checklist\n1. [ ] Export Vendure orders in \"Authorized\" state (last 24h)\n   - Count: expected? (should be low, typically <5)\n2. [ ] Cross-reference with GPG dashboard transactions\n   - Compare transaction IDs, amounts, timestamps\n   - Look for discrepancies: Vendure \"Authorized\" but GPG \"Captured\"\n3. [ ] For discrepancies:\n   - [ ] Capture: if GPG \"Captured\" → replay webhook or manual capture\n   - [ ] Refund: if GPG \"Refunded\" but Vendure \"Captured\" → check refund log\n   - [ ] Failed: if GPG \"Failed\" → customer needs to retry; close ticket\n4. [ ] Log findings:\n   - Record count of orders reconciled\n   - Note any manual actions taken\n   - Flag unusual patterns (e.g., spike in failures)\n5. [ ] Alert if issues found:\n   - >10% failure rate → escalate to engineering\n   - Signature validation errors → check GPG_SECRET env var\n\n### Weekly Deep Dive (Friday afternoon)\n1. [ ] Review webhook retry logs (past 7 days)\n   - Any patterns? Specific times of day?\n2. [ ] Check refund accuracy\n   - Sample 5 refunds; verify amounts in both systems\n3. [ ] Monitor payment latency\n   - Target: <5s from API payment creation → GPG redirect\n   - If >10s, investigate network or GPG API delays\n4. [ ] Review customer complaints\n   - Any payment-related support tickets?\n   - Identify root cause; document in runbook\n\n---\n\n## Incident Response: Payment Failure Spike\n\n### Alert: >5% of payments failing in 1 hour\n\n### Triage (5 min)\n1. [ ] Check GPG status page: is GPG API down?\n   - If yes: notify customers, wait for recovery\n   - If no: proceed to step 2\n2. [ ] Check API logs: `/api/logs/webhooks`\n   - Any error patterns? (timeout, invalid response, signature failure)\n3. [ ] Check network: is Vendure → GPG connectivity OK?\n   - Ping GPG endpoint: `curl https://gpg-api.example.com/health`\n4. [ ] Check config: are GPG env vars correct?\n   - Verify: `GPG_ENDPOINT`, `GPG_MERCHANT_ID`, `GPG_SECRET`\n\n### Mitigation (15 min)\n- **Option 1**: Temporarily disable `payments.gpgEnabled` (fallback payment method)\n- **Option 2**: Scale up API replicas (if issue is throughput)\n- **Option 3**: Contact GPG support (if API is slow/unavailable)\n\n### Recovery\n1. [ ] Once root cause fixed, re-enable GPG or verify recovery\n2. [ ] Replay failed payment webhooks (see section above)\n3. [ ] Email affected customers: \"Payment issue resolved; please retry or contact support\"\n4. [ ] Post-incident review: update monitoring, improve alerts\n\n---\n\n## Environment Variables: Update & Restart\n\n### Scenario: GPG_SECRET rotated; need to update and restart API\n\n### Steps (Minimal Downtime)\n1. [ ] Update `.env` or secret manager with new value\n2. [ ] Verify no orders in flight (check admin dashboard; wait if >100 orders in \"Checkout\")\n3. [ ] Restart API service:\n   - Docker: `docker restart vendure-api`\n   - Kubernetes: `kubectl rollout restart deployment/vendure-api`\n   - Node: stop process, update .env, start\n4. [ ] Verify API is healthy:\n   - GraphQL query: `{ __typename }`\n   - Check logs for errors\n5. [ ] Test payment flow in sandbox (if payment-related change):\n   - Create test order; verify GPG redirect works\n6. [ ] Monitor error rates (5 min): should return to baseline\n\n### Avoiding Downtime\n- Use blue-green deployment: run new API version with new secret, switch traffic once ready\n- Or: use environment variable hot-reload (if framework supports; Vendure may require restart)\n\n---\n\n## Logs & Monitoring\n\n### Key Logs to Monitor\n\n- **Payment**: `/api/logs/webhooks/gpg` → webhook events\n- **Shipping**: `/api/logs/shipping-export` → export batch events\n- **Loyalty**: `/api/logs/loyalty` → earn/burn ledger\n- **Cache**: `/api/logs/cache` → Redis hits/misses, CF purges\n- **Errors**: `/api/logs/errors` → 5xx, exceptions\n\n### Setting Up Alerts\n\nUse your logging platform (CloudWatch, Datadog, etc.):\n\n```\nAlert: Payment webhook failure rate >5% in 1 hour\nAlert: Export batch failure >3 consecutive batches\nAlert: API response latency >2s (p99)\nAlert: GPG_SECRET validation failure (fraud attempt?)\nAlert: Cache purge latency >5s\n```\n\n### Runbook Links\n- Ops: this document\n- QA: qa-checklist.md\n- Specs: all in docs/specs/\n