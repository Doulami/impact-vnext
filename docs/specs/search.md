# Search Specification\n\n## Meili ON (search.meiliEnabled = true)\n\n### Index Structure\n\n#### Product Index\n- **Name**: `${meiliIndexPrefix}products` (e.g., \"prod_products\")\n- **Fields**:\n  - `id` (String, searchable)\n  - `sku` (String, searchable)\n  - `title` (String, searchable, primary)\n  - `description` (String, searchable)\n  - `tags` (Array[String], searchable)\n  - `price` (Number, filterable, sortable)\n  - `discount_price` (Number, filterable, sortable) — null if no promo\n  - `in_stock` (Boolean, filterable)\n  - `rating` (Decimal, filterable, sortable) — 0–5\n  - `category` (String, filterable)\n  - `collections` (Array[String], filterable)\n  - `created_at` (DateTime, sortable)\n  - `updated_at` (DateTime, sortable)\n\n#### Variant Index (Optional)\n- **Name**: `${meiliIndexPrefix}variants`\n- Mirrors Product but includes:\n  - `parent_product_id`\n  - `variant_title` (e.g., \"Protein Shake - Vanilla\")\n  - `variant_sku`\n\n### Search Features\n\n**Full-text search**\n- Type-ahead / autocomplete on product title & description\n- Typo tolerance: 1–2 character edits (configurable)\n- Word stemming: \"protein\" matches \"proteins\"\n- Phrase search: \"plant-based\" as exact phrase\n\n**Synonyms** (optional, v1.1)\n- \"whey\" = \"whey protein\"\n- \"shake\" = \"beverage\"\n- \"bar\" = \"snack bar\"\n\n**Filtering**\n- Price range: `filter=price:[10 TO 50]`\n- In stock: `filter=in_stock=true`\n- Category: `filter=category=\"Nutrition\"`\n- Multiple tags: `filter=tags IN [\"vegan\", \"gluten-free\"]`\n\n**Sorting**\n- Relevance (default)\n- Price ascending / descending\n- Newest (created_at desc)\n- Highest rated (rating desc)\n\n### Reindex Triggers\n\n| Trigger | API Event | Action |\n|---------|-----------|--------|\n| New product | productCreated | index new entry |\n| Price change | priceChanged | update price field |\n| Stock change | inventoryUpdated | update in_stock field |\n| Description edit | productUpdated | reindex full document |\n| Collection change | productRemoved / productAdded | update collections array |\n| Batch sync | manual sync endpoint | full reindex |\n\n### Webhook Handler\n```\nVendure API event → Meli sync service → Meli API\n  - Async: queue-based (bull/BullMQ)\n  - Retry: 3 attempts with exponential backoff\n  - Timeout: 10s per event; dead-letter queue if failed\n```\n\n### Query Performance\n- **Latency target**: <100ms for typical query\n- **Pagination**: default 20 results/page; max 100\n- **Facets**: return aggregated counts for filters (categories, tags)\n\n## Meili OFF (Fallback to API Filter)\n\n### Search Endpoint\n- **Query**: `/api/search?q=protein&price_min=10&price_max=50&category=Nutrition`\n- **Data source**: Vendure GraphQL search query\n- **Filters**: exact/contains match on title, SKU, tags\n\n### Behavior\n- **Latency**: slower than Meili (~500ms–2s depending on catalog size)\n- **No typo tolerance**: \"protien\" does NOT match \"protein\"\n- **No full-text**: searches title only, not description\n- **Sorting**: limited (relevance score not calculated)\n- **UX acceptable**: basic catalog browsing still works\n\n### API Query\n```graphql\nquery SearchProducts($term: String, $filters: ProductFilterInput) {\n  products(search: $term, filter: $filters, first: 20) {\n    edges {\n      node {\n        id title sku price rating\n      }\n    }\n  }\n}\n```\n\n## Zero-Results Handling\n\n### Meili ON\n- **Logging**: log query terms + filter state to analytics\n- **Suggestions**: \n  - Did you mean: suggest corrections if query has typos\n  - Browse: show related categories\n  - Broaden: suggest \"Did you search for [without filters]?\"\n- **Synonym playbook**:\n  - If zero results, check if term is new synonym candidate\n  - Log for manual review; add to synonym list if valid\n\n### Meili OFF\n- **Same logging & suggestions**\n- **Manual filter**: admin can add custom search mappings (title:\"shake\" → includes beverage category)\n\n## Configuration\n\n### Environment\n```\nMEILI_HOST=https://search.example.com\nMEILI_KEY=<master-key>\nMEIL_INDEX_PREFIX=prod_\nSEARCH_RESULT_LIMIT=20\nSEARCH_TYPO_TOLERANCE=1  # 0-2 chars\n```\n\n### Admin Settings (Future M8)\n- Enable/disable Meili (toggle feature flag)\n- Reindex trigger: manual button + schedule cron\n- Synonym management UI\n- Zero-results insights dashboard\n\n## Migration & Rollover\n\n### From OFF → ON\n1. Set up Meili cluster\n2. Full reindex via batch job (async)\n3. Verify result quality (sample queries, compare to fallback)\n4. Enable flag: `search.meiliEnabled = true`\n5. Monitor search latency & error rates for 24 hours\n6. Fallback if needed: set flag back to false\n\n### From ON → OFF\n1. Set flag: `search.meiliEnabled = false`\n2. Queries route to API fallback automatically\n3. Meili cluster can be paused/stopped (kept for quick re-enable)\n\n## Analytics & Monitoring\n\n- **Search queries**: log term, filters, result count, latency\n- **Click-through**: track which products clicked from search results (v1.1)\n- **Alerts**:\n  - Search latency >1s → investigate\n  - Zero-result rate >20% → review catalog, synonyms, filters\n  - Meili API errors → alert ops\n\n## Performance Benchmarks (Target)\n\n| Scenario | Meili | Fallback | Acceptable? |\n|----------|-------|----------|-------------|\n| \"protein\" (1000 results) | 50ms | 1200ms | Yes (limit 20/page) |\n| \"protien\" typo tolerance | 55ms | N/A (no match) | Yes (Meili suggestion) |\n| Price filter + category | 45ms | 800ms | Yes |\n| Zero-results query | 30ms | 500ms | Yes |\n