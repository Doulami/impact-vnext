# Performance & PWA Specification\n\n## Next.js Web Performance\n\n### ISR (Incremental Static Regeneration)\n\n| Route | Revalidate (s) | Trigger | Strategy |\n|-------|---|---------|----------|\n| `/` | 3600 | Strapi promo change; featured product update | Static + ISR |\n| `/c/[collection]` | 1800 | Inventory / price change webhook | Static + ISR |\n| `/p/[handle]` | 600 | Variant / inventory change | Static + ISR |\n| `/content/[slug]` | 3600 | Strapi publish webhook | Static + ISR |\n| `/search` | 0 | N/A | Server-rendered |\n| `/cart` | 0 | N/A | Client-side |\n| `/checkout/*` | 0 | N/A | Client-side |\n| `/account/*` | 0 | N/A | Client-side + SSR |\n\n### Cache Headers\n- **Public pages** (home, PLP, PDP): `Cache-Control: public, s-maxage=600, stale-while-revalidate=86400`\n- **Checkout pages**: `Cache-Control: private, no-cache, no-store`\n- **Account pages**: `Cache-Control: private, no-cache` (requires auth)\n\n### Image Optimization\n- **Next/Image component**: all product images\n- **Responsive srcsets**: 320w, 640w, 960w, 1280w\n- **Lazy loading**: lazy by default, eager for above-fold (LCP candidate)\n- **Formats**: WebP + JPEG fallback\n- **Alt text**: required (accessibility & SEO)\n\n### Code Splitting\n- **Per-route bundles**: automatic via App Router\n- **Dynamic imports**: payment providers, Meili client (only if flag enabled)\n- **Tree-shaking**: unused exports removed\n\n### Core Web Vitals Targets (if cache.edgeEnabled)\n- **LCP (Largest Contentful Paint)**: <75ms\n  - Strategy: defer non-critical JS, optimize images, preload fonts\n- **FID (First Input Delay)**: <100ms\n  - Strategy: minimize main thread work during checkout\n- **CLS (Cumulative Layout Shift)**: <0.1\n  - Strategy: reserve space for ads/banners, avoid dynamic height changes\n\n## Vendure API Caching\n\n### Redis Cache (Preferred)\n- **Configuration**: `REDIS_URL` env var\n- **Catalog queries**: 60s TTL\n  - Product by ID, SKU, collection\n  - Search results (if Meili OFF)\n- **Basket calculations**: 30s TTL\n  - Cart totals, shipping estimates, taxes\n- **Session**: TTL varies (default 7 days)\n\n### In-Memory Fallback\n- **Fallback**: if Redis unavailable or connection fails\n- **Max size**: 100MB (configurable)\n- **Behavior**: slower; suitable for development/testing only\n\n### No-Cache Endpoints\n- **Cart**: always real-time (no cache)\n- **Checkout state**: no cache\n- **Customer session**: no cache\n- **Current inventory**: 10s TTL (soft cache for display; always verify at checkout)\n\n### Cache Invalidation\n- **TTL-based**: automatic expiry after TTL\n- **Event-based**: plugin hooks on product/inventory/price change (if cache.edgeEnabled)\n- **Manual**: admin endpoint `/admin/cache/purge` (future M8)\n\n## Cloudflare Edge Caching (cache.edgeEnabled = true)\n\n### Surrogate Keys\n- **Per product**: `cf-surrogate-key: product-${productId}`\n- **Per collection**: `cf-surrogate-key: collection-${collectionId}`\n- **Per category**: `cf-surrogate-key: category-${categoryId}`\n- **Pattern**: `cf-surrogate-key: product-* collection-* category-*`\n\n### Purge Hooks\n```\nVendure plugin triggers on:\n  - Product updated → purge product-${id} + collection-* (related collections)\n  - Inventory changed → purge product-${id}\n  - Price changed → purge product-${id}\n  - Collection updated → purge collection-${id}\n  → API calls CF Purge API with surrogate keys\n```\n\n### Configuration\n```\nCLOUDFLARE_ZONE_ID=<zone-id>\nCLOUDFLARE_API_TOKEN=<api-token>\nCACHE_EDGE_ENABLED=true  # feature flag\n```\n\n### Monitoring\n- **Hit ratio**: track % of requests served from CF cache\n- **Purge latency**: time from product change → cache invalidation (target <2s)\n- **Alerts**: purge failures, hit ratio drop >10%\n\n## PWA (Progressive Web App)\n\n### Manifest\n```json\n{\n  \"name\": \"Impact Nutrition\",\n  \"short_name\": \"Impact\",\n  \"description\": \"Premium nutrition supplements\",\n  \"start_url\": \"/\",\n  \"scope\": \"/\",\n  \"display\": \"standalone\",\n  \"orientation\": \"portrait-primary\",\n  \"theme_color\": \"#FF6B35\",\n  \"background_color\": \"#FFFFFF\",\n  \"icons\": [\n    { \"src\": \"/icons/192.png\", \"sizes\": \"192x192\", \"type\": \"image/png\" },\n    { \"src\": \"/icons/512.png\", \"sizes\": \"512x512\", \"type\": \"image/png\" },\n    { \"src\": \"/icons/mask.svg\", \"sizes\": \"192x192\", \"type\": \"image/svg+xml\", \"purpose\": \"maskable\" }\n  ]\n}\n```\n\n**Branding source**: Strapi `StoreConfig.branding` (name, description, theme color, logoUrl)\n\n### Service Worker\n\n**Scope**: `/`\n\n**Caching Strategy**:\n- **PDP + Cart shell**: cache-first (offline read)\n- **PLP**: stale-while-revalidate (offline, then refresh)\n- **Home**: stale-while-revalidate\n- **API calls**: network-first (always try fresh; fallback to cache if offline)\n- **Static assets**: cache-first (JS, CSS, fonts)\n\n**Offline Fallback**:\n```\nGET /p/[handle] while offline → serve cached PDP + \"You're offline. Last updated: [timestamp]\"\nGET /cart while offline → serve cached cart\nGET / while offline → serve cached home shell + \"Offline mode. Some content may be outdated.\"\nGET /checkout → error: \"Checkout unavailable offline\"\n```\n\n**Update Behavior**:\n- **Check for updates**: every app open\n- **New version available**: notify user: \"An update is available. Refresh to get the latest.\"\n- **Skip waiting**: disabled; user must manually refresh (avoid disruption)\n\n### Install Prompt\n\n**Trigger** (if `pwa.enabled = true`):\n- Home page after 10s (or on second visit)\n- Show: \"Add to home screen\" button + brief explanation\n- Dismissal: remembered for 30 days\n\n**Behavior** (if `pwa.enabled = false`):\n- No install prompt shown\n- SW + manifest still cached (can be enabled later)\n\n### Performance Implications\n- **First visit**: manifest download (~5KB), SW registration (~30KB gzipped)\n- **Subsequent visits**: instant load (app shell from cache)\n- **Offline**: core browse/cart functionality available\n- **Sync**: optional background sync for form submissions (v1.1)\n\n## Monitoring & Analytics\n\n### Web Vitals\n- **Tool**: Web Vitals JS library → send to analytics\n- **Metrics**: LCP, FID, CLS, TTFB, FCP\n- **Alert**: if LCP >3s, alert ops\n\n### Cache Hit Rates\n- **API (Redis)**: track cache hits vs. misses per endpoint\n- **CF edge**: Cloudflare analytics dashboard\n- **Browser**: observe Service Worker cache size + hit rate\n\n### Errors & Failures\n- **Log**: failed image loads, API timeouts, SW registration failures\n- **Replay**: WebVitals data for users experiencing issues\n\n## Performance Budget\n\n**Bundle size**:\n- **Initial JS**: <150KB (gzipped)\n- **CSS**: <50KB\n- **Images**: responsive; <300KB median per page\n\n**Core Web Vitals** (target for top 75th percentile):\n- LCP: <2.5s\n- FID: <100ms\n- CLS: <0.1\n\n**If cache.edgeEnabled**:\n- Target LCP <75ms via surrogate keys + aggressive caching\n