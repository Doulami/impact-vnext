# Loyalty Module Specification\n\n## Overview\nOptional loyalty points system: customers earn points on purchases, redeem at checkout. Gated by `loyalty` feature flag.\n\n## Earn Rule\n\n### Trigger\n- **Event**: Order paid (payment captured)\n- **Calculation**: `(net_paid_amount * earn_rate) / 100`\n- **Earn rate**: configurable percentage (e.g., 1% → 100 points per $100 spent)\n- **Net amount**: subtotal + tax − discounts (excludes shipping)\n\n### Example\n- Order subtotal: $100\n- Tax: $8\n- Promo discount: −$10\n- Shipping: $5 (excluded)\n- **Net paid**: $103 − $10 = $93\n- **Points earned** (at 1%): 93 points\n\n### Exclusions\n- **Bundled items**: if bundle flag OFF, component SKUs still earn normally\n- **Clearance items**: may be excluded (configurable tag/flag)\n- **Gift cards / service fees**: excluded by category\n\n## Burn Rule\n\n### Trigger\n- **Event**: Checkout, customer selects \"Redeem points\"\n- **Redemption**: customer selects amount of points to burn\n- **Conversion**: 1 point = $0.01 (configurable)\n- **Discount**: applied to order subtotal before tax\n\n### Limits\n- **Max redeem per order**: capped at 50% of order subtotal (prevents over-redemption)\n- **Min balance**: customer can only redeem if balance ≥ 100 points\n- **Fractional**: only whole points redeemable (no 0.5 point)\n\n### Example\n- Cart subtotal: $100\n- Customer balance: 5000 points (= $50 credit)\n- Max redeemable: 50% of $100 = $50 = 5000 points ✓\n- Customer selects: 3000 points (= $30 discount)\n- **New subtotal**: $70 + tax\n\n## Ledger Model\n\n### Ledger Entry\n\n| Field | Type | Example | Notes |\n|-------|------|---------|-------|\n| `id` | UUID | uuid-123 | primary key |\n| `customer_id` | UUID | cust-456 | Vendure customer |\n| `order_id` | String | CMR-001 | nullable (earn) or set (burn) |\n| `transaction_type` | Enum | \"awarded\" / \"redeemed\" / \"adjusted\" | |\n| `points_delta` | Integer | +93 or −3000 | signed |\n| `previous_balance` | Integer | 5000 | snapshot before |\n| `new_balance` | Integer | 5093 | snapshot after |\n| `reason` | String | \"Order paid\" or \"Manual adjustment\" | for auditing |\n| `expires_at` | DateTime | null | nullable; v2 feature |\n| `created_at` | DateTime | 2024-11-04T13:30:00Z | timestamp |\n| `metadata` | JSON | {} | extra context (refund reason, etc.) |\n\n### Ledger Operations\n\n**Award (Earn)**\n```json\n{\n  \"transaction_type\": \"awarded\",\n  \"points_delta\": 93,\n  \"reason\": \"Order CMR-001 paid\",\n  \"order_id\": \"CMR-001\"\n}\n```\n\n**Redeem (Burn)**\n```json\n{\n  \"transaction_type\": \"redeemed\",\n  \"points_delta\": -3000,\n  \"reason\": \"Checkout redemption\",\n  \"order_id\": \"CMR-002\",\n  \"metadata\": { \"discount_value_usd\": 30 }\n}\n```\n\n**Adjust (Refund / Manual)**\n```json\n{\n  \"transaction_type\": \"adjusted\",\n  \"points_delta\": -93,\n  \"reason\": \"Order CMR-001 refunded\",\n  \"metadata\": { \"refund_reason\": \"customer_return\" }\n}\n```\n\n## Account UX Surfaces\n\n### Loyalty Dashboard (/account/loyalty)\n- **Current balance**: large, prominent display (e.g., \"5,093 points = $50.93\")\n- **Tier status**: optional (v1 = none; v2 = silver/gold/platinum)\n- **Recent activity**: last 10 transactions (award, redeem, adjust)\n- **Redeem form**: input desired points or dollar amount; calculate discount; \"Apply\" button\n\n### At Checkout\n- **Loyalty section** (if flag enabled): \n  - \"You have 5,093 points\"\n  - Input: \"Redeem points\" [____] button\n  - Real-time discount preview: \"You'll save $30.00\"\n  - Checkbox: \"Apply discount\" (default checked if redeemed)\n  - Remaining balance after redemption: \"You'll have 2,093 points left\"\n\n### In Order Confirmation Email\n- Points earned summary: \"You earned 93 points on this order! Balance: 5,093\"\n- (If redeemed) \"You redeemed 3,000 points for $30 discount.\"\n\n## OFF Behavior (Flag = false)\n\n### UX Changes\n- **Account page**: no Loyalty tab or section\n- **Checkout**: no loyalty input or discount option\n- **Email**: no \"points earned\" message\n- **API**: no loyalty mutations or queries exposed\n\n### Backend Changes\n- **Earn trigger**: disabled; no ledger entries created\n- **Burn logic**: skipped; no discount applied\n- **Queries**: return null if queried (error for GraphQL)\n\n## Configuration (Future Admin UI)\n\n### Earn Settings\n- Earn rate (%): default 1%\n- Excluded categories / tags\n- Enable/disable by customer segment (v2)\n\n### Burn Settings\n- Conversion rate (points per $): default 100 points = $1\n- Max redeem % of order: default 50%\n- Min balance to redeem: default 100 points\n\n### Expiry (v2 feature)\n- Expiry enabled: boolean\n- Expiry window: days (e.g., 365 = 1 year from award)\n- Notify customer: email at 30 days before expiry\n\n## Reconciliation & Refunds\n\n### Order Refund\n- **Refund full order**: reverse earn entry (create \"adjusted\" entry with negative points)\n- **Partial refund**: calculate proportional points; create adjusted entry\n- **Burn reversal**: if customer had redeemed points in that order, reverse the redeem entry too\n- **Workflow**: refund initiated → ledger entries created → customer balance updated → email sent\n\n### Negative Balance Prevention\n- **Constraint**: never allow balance < 0\n- **Refund edge case**: if refunding reverses redeem but customer already spent those points, set balance to 0 + new adjustments\n- **Audit**: flag negative balance events in logs for investigation\n\n## API Contracts\n\n### Query: Customer Loyalty Balance\n```graphql\nquery {\n  me {\n    customer {\n      loyalty {\n        balance\n        tier\n        nextTierRequiredPoints\n      }\n    }\n  }\n}\n```\n\n### Query: Loyalty Ledger\n```graphql\nquery {\n  me {\n    customer {\n      loyaltyLedger(first: 20) {\n        edges {\n          node {\n            id\n            transactionType\n            pointsDelta\n            newBalance\n            reason\n            createdAt\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n### Mutation: Redeem Points (Checkout)\n```graphql\nmutation {\n  redeemLoyaltyPoints(orderId: \"...\", points: 3000) {\n    order {\n      id\n      discounts { description amount }\n      total\n    }\n    customer {\n      loyalty { balance }\n    }\n  }\n}\n```\n