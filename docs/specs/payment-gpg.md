# GPG Checkout Specification\n\n## Payment Flow\n\n```\n1. Customer selects GPG at checkout (if payments.gpgEnabled)\n       ↓\n2. Vendure creates PaymentIntent with GPG provider\n       ↓\n3. API generates signed redirect URL\n       ↓\n4. Browser redirects to GPG hosted page (customer enters card)\n       ↓\n5. GPG processes payment, posts webhook to /webhooks/gpg\n       ↓\n6. Webhook validates signature & updates PaymentIntent state\n       ↓\n7. Customer redirected to confirmation page (or returnUrl)\n       ↓\n8. Order marked as \"Paid\" or \"Awaiting Payment\" (capture)\n```\n\n## Integration Points\n\n### Payment Creation\n- **Endpoint**: Vendure Shop API mutation `createPaymentIntent`\n- **Inputs**:\n  - `orderId`: Vendure order ID\n  - `amount`: in cents (e.g., 4999 = $49.99)\n  - `currency`: ISO 4217 code (e.g., \"USD\")\n  - `returnUrl`: success redirect URL\n  - `cancelUrl`: cancellation redirect URL\n- **Output**: \n  - `paymentId`: Vendure payment record ID\n  - `gpgRedirectUrl`: signed GPG checkout URL\n  - `signature`: HMAC SHA256 signature\n\n### Hosted Page Parameters\n- **merchantId**: from `GPG_MERCHANT_ID`\n- **orderId**: Vendure order ID (tracked in GPG)\n- **amount**: cents\n- **currency**: ISO code\n- **signature**: HMAC(\"merchantId:orderId:amount:currency\", GPG_SECRET)\n- **returnUrl**: https://storefront.com/checkout/confirmation?orderId=...\n- **cancelUrl**: https://storefront.com/checkout?error=cancelled\n- **webhookUrl**: https://api.com/webhooks/gpg\n\n## Webhook Events\n\nGPG POSTs to `/api/webhooks/gpg` with JSON body:\n\n```json\n{\n  \"event\": \"authorized|captured|failed|refunded\",\n  \"orderId\": \"vndr-123\",\n  \"paymentId\": \"gpg-456\",\n  \"amount\": 4999,\n  \"currency\": \"USD\",\n  \"transactionId\": \"gpg-txn-789\",\n  \"timestamp\": \"2024-11-04T13:30:00Z\",\n  \"signature\": \"HMAC-signature\"\n}\n```\n\n### Event Semantics\n\n| Event | Vendure State | Action | Refundable? |\n|-------|---------------|--------|-------------|\n| `authorized` | Authorized | Reserve funds; await capture | Yes |\n| `captured` | Captured | Funds settled | Yes |\n| `failed` | Failed | Decline order; clear payment intent | No |\n| `refunded` | Refunded | Credit customer; order mark refunded | N/A |\n\n### Idempotency & Retry\n- **Idempotency key**: `gpg_txn_${transactionId}` stored in Vendure payment metadata\n- **Duplicate webhook**: check key; if exists, return 200 OK without re-processing\n- **Retry window**: GPG retries webhook for 24 hours; API logs all attempts\n- **Timeout**: API responds with 200 OK within 5s to prevent re-delivery\n\n## Signature Validation\n\n```typescript\n// Node.js example\nimport crypto from 'crypto';\n\nconst validateWebhook = (body, gpgSignature) => {\n  const expected = crypto\n    .createHmac('sha256', process.env.GPG_SECRET)\n    .update(JSON.stringify(body))\n    .digest('hex');\n  return expected === gpgSignature;\n};\n```\n\n## Error Handling & Messaging\n\n### Customer-Facing Errors\n- **Card declined**: \"Your card was declined. Please try another payment method.\"\n- **Timeout**: \"Payment processing timed out. Please try again or contact support.\"\n- **Network error**: \"Unable to process payment. Please try again.\"\n- **Invalid address**: \"Please correct your billing address and try again.\"\n\n### Operator Recovery\n- **Manual capture**: Admin UI allows \"Authorize → Capture\" workflow for stuck orders\n- **Refund**: Admin UI allows full or partial refund; triggers webhook or manual settlement\n- **Replay webhook**: admin endpoint `/admin/webhooks/gpg/replay?transactionId=...` (idempotent)\n\n## Payment Reconciliation Runbook\n\n### Daily Reconciliation Check\n1. Export Vendure orders in \"Authorized\" state for >24 hours\n2. Cross-reference GPG transaction IDs with GPG dashboard\n3. For discrepancies:\n   - If GPG shows \"Captured\" but Vendure \"Authorized\": manually trigger capture webhook replay\n   - If Vendure \"Captured\" but GPG \"Authorized\": contact GPG support or manual settle\n4. Log discrepancies for investigation\n\n### Failed Payment Recovery\n- Customer emails support → create support ticket\n- Admin searches order by email/ID\n- Checks payment state in Vendure (Failed / Authorized)\n- If \"Authorized\": attempt capture; if success, confirm to customer\n- If \"Failed\": customer must retry checkout with fresh payment\n\n### Refund Process\n- Customer requests refund (post-purchase)\n- Admin UI (future M8) allows refund by order ID\n- API calls GPG refund API (`POST /refund`)\n- Webhook arrives with `refunded` event\n- Order marked \"Refunded\"; email sent to customer\n\n## Logging & Monitoring\n\n- **Payment intent creation**: log merchantId, amount, returnUrl\n- **Webhook receipt**: log event type, transactionId, timestamp\n- **Webhook processing**: log success/failure; alert on signature validation failure\n- **Alerts**: set up monitoring for:\n  - Spike in `failed` events (>5% of daily orders)\n  - Webhook latency >5s\n  - Signature validation failures (potential fraud/misconfiguration)\n\n## Admin UI (Future M8)\n\n- **Payment timeline view**: authorized → captured, refunded, failed states with timestamps\n- **Manual capture button**: \"Capture payment\" for authorized-only orders\n- **Manual refund**: full or partial amount input + reason\n- **Webhook replay**: search by transactionId, trigger re-delivery\n- **Reconciliation report**: daily summary, discrepancies flagged\n