# Shipping File Bridge Specification\n\n## Overview\nAutomated export of \"Ready to Ship\" orders to a file-based system (SFTP or HTTPS), enabling handoff to external shipping/fulfillment operators. Triggered by schedule (cron) or manual export.\n\n## Trigger Points\n\n### Scheduled Export\n- **Cron schedule**: from `SHIP_EXPORT_SCHEDULE` env var (e.g., `\"0 8 * * *\"` = 8 AM daily)\n- **Batch window**: export all orders in \"Ready to Ship\" state since last export\n- **Timestamp**: record export time in order metadata (`exported_at`, `batch_id`)\n\n### Manual Export\n- **Admin endpoint**: `/admin/orders/export-shipping` (POST)\n- **Query**: filter by date range or order IDs\n- **Response**: file reference + batch ID\n\n## File Schema\n\n### Format\n- **Default**: CSV (tab-separated for safety)\n- **Encoding**: UTF-8 with BOM\n- **Header row**: included\n\n### Columns\n\n| Column | Type | Example | Notes |\n|--------|------|---------|-------|\n| `order_id` | String | \"CMR-00001\" | Vendure order reference |\n| `customer_name` | String | \"John Doe\" | Shipping recipient |\n| `customer_phone` | String | \"+1-555-1234\" | Contact number |\n| `address_line_1` | String | \"123 Main St\" | |\n| `address_line_2` | String | \"Apt 4B\" | nullable |\n| `city` | String | \"Portland\" | |\n| `state_province` | String | \"OR\" | ISO or abbreviation |\n| `postal_code` | String | \"97201\" | |\n| `country_code` | String | \"US\" | ISO 3166-1 alpha-2 |\n| `items_skus` | String | \"SKU-001,SKU-002\" | comma-separated, no spaces |\n| `items_qty` | String | \"2,1\" | qty per SKU (same order) |\n| `items_names` | String | \"Protein Shake,Bars\" | comma-separated |\n| `weight_kg` | Decimal | \"2.5\" | total package weight |\n| `special_notes` | String | \"Handle with care\" | nullable; gift wrapping, allergies, etc. |\n| `cod_flag` | Boolean | \"0\" or \"1\" | collect on delivery |\n| `carrier_service` | String | \"standard\" or \"express\" | from Vendure shipping method |\n| `export_timestamp` | DateTime | \"2024-11-04T13:30:00Z\" | file creation time |\n| `batch_id` | String | \"exp-20241104-1\" | unique batch identifier |\n\n### Example Row\n```\nCMR-00001\tJohn Doe\t+1-555-1234\t123 Main St\tApt 4B\tPortland\tOR\t97201\tUS\tSKU-001,SKU-002\t2,1\tProtein Shake,Bars\t2.5\tHandle with care\t0\tstandard\t2024-11-04T13:30:00Z\texp-20241104-1\n```\n\n## Transport\n\n### SFTP (Preferred)\n- **Host**: `SHIP_REMOTE_HOST`\n- **Port**: 22 (default) or from config\n- **User**: `SHIP_REMOTE_USER`\n- **Password**: `SHIP_REMOTE_PASSWORD` (or SSH key)\n- **Directory**: `/inbound/` (target remote path)\n- **Filename**: `orders-${batchId}-${timestamp}.csv`\n- **Retry**: 3 attempts with 30s backoff; fail after 5 min\n\n### HTTPS (Fallback)\n- **Endpoint**: `SHIP_REMOTE_HOST`\n- **Method**: POST multipart/form-data\n- **Auth**: Bearer token or basic auth from config\n- **Body**: file upload + metadata JSON\n- **Retry**: same as SFTP\n\n## Order State Management\n\n### Before Export\n- Order state: \"Ready to Ship\" (Vendure fulfillment state)\n- Check constraints:\n  - All line items have valid SKU mappings\n  - Shipping address complete\n  - Payment authorized or captured\n\n### During Export\n- Create batch record in database with timestamp, file path, status (pending)\n\n### After Export\n- Mark order with metadata:\n  - `fulfillment_exported_at`: timestamp\n  - `export_batch_id`: batch ID\n  - `export_file_path`: local or remote path\n- Update order status (optional): \"In Transit\" or keep \"Ready to Ship\" (operator-specific)\n- Log in order timeline: \"Exported to shipping bridge\"\n\n### Export Failure\n- Batch marked as \"Failed\"\n- Orders remain in \"Ready to Ship\"\n- Alert sent to ops team\n- Automatic retry: after 30 min (max 3 attempts)\n\n## Re-Export Logic\n\n### Manual Re-Export (Idempotent)\n- Operator specifies batch ID or order ID range\n- Check: if order already exported in batch X, ask for confirmation (\"Re-export will send duplicate; proceed?\")\n- Re-export creates new batch ID; marks previous as \"superseded\"\n- Shipping remote operator deduplicates on their end (check order_id)\n\n### Partial Re-Export\n- Select subset of orders from failed batch\n- Create new batch with suffix (e.g., \"exp-20241104-1-retry\")\n- Export file includes only selected orders\n\n## Logging & Monitoring\n\n- **Export start**: log batch ID, order count, destination\n- **Upload**: log file size, transfer time, status (success/fail)\n- **Errors**: log detailed error message; categorize (network, auth, data validation)\n- **Monitoring alerts**:\n  - Export failure rate >5% in 1 hour\n  - Upload latency >2 min\n  - Skipped orders (validation errors) >10\n\n## Future: Carrier API Integration\n\n### Phase 2 Plan\n- Replace file export with direct carrier API calls (FedEx, UPS, DHL)\n- Trigger: same \"Ready to Ship\" event\n- Response: carrier tracking number â†’ stored in order metadata\n- User notification: email with tracking link\n- Fallback: if carrier API down, fall back to file export\n- Feature flag: `shipping.fileBridgeEnabled` controls legacy file path; new carrier mode independent\n\n## Data Privacy & Security\n\n- **PII**: customer names, phone, addresses in file; ensure encryption in transit (SFTP + TLS)\n- **Retention**: delete exported files after 90 days or per local law\n- **Audit**: log all re-exports with operator ID (future auth)\n- **Access control**: only fulfillment operators can trigger export (admin role)\n